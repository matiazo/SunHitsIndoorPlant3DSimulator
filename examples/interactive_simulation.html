<!DOCTYPE html>
<html>
<head>
    <title>Sun-Plant Simulation</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            font-size: 24px;
            padding: 10px 20px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 15px;
        }
        .status.hit {
            background: #4CAF50;
            color: white;
        }
        .status.miss {
            background: #9E9E9E;
            color: white;
        }
        .info {
            color: #666;
            font-size: 14px;
        }
        .slider-container {
            margin: 20px 0;
        }
        #timeSlider {
            width: 100%;
            height: 30px;
            cursor: pointer;
        }
        .plot-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
        /* Config panel styles */
        .config-panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-header {
            background: #f0f0f0;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .config-header:hover {
            background: #e8e8e8;
        }
        .config-toggle {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .config-toggle.open {
            transform: rotate(180deg);
        }
        .config-body {
            padding: 20px;
            display: none;
            border-top: 1px solid #ddd;
        }
        .config-body.open {
            display: block;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .config-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }
        .config-group h4 {
            margin: 0 0 12px 0;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
        }
        .config-field {
            margin-bottom: 12px;
        }
        .config-field:last-child {
            margin-bottom: 0;
        }
        .config-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .config-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .config-field input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .config-field .value-display {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        .config-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .config-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-apply {
            background: #4CAF50;
            color: white;
        }
        .btn-apply:hover {
            background: #45a049;
        }
        .btn-reset {
            background: #f44336;
            color: white;
        }
        .btn-reset:hover {
            background: #da190b;
        }
        .btn-export {
            background: #2196F3;
            color: white;
        }
        .btn-export:hover {
            background: #1976D2;
        }
        .saved-indicator {
            color: #4CAF50;
            font-size: 12px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .saved-indicator.show {
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sun Hits Indoor Plant - 3D Simulation</h1>
        <h2 style="color: #666; margin-top: 0;">Date: 2026-02-01</h2>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="config-header" onclick="toggleConfig()">
                <span>⚙️ Configuration <span class="saved-indicator" id="savedIndicator">✓ Saved</span></span>
                <span class="config-toggle" id="configToggle">▼</span>
            </div>
            <div class="config-body" id="configBody">
                <div class="config-grid">
                    <div class="config-group">
                        <h4>Plant Position</h4>
                        <div class="config-field">
                            <label>Center X (meters)</label>
                            <input type="number" id="plantCenterX" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 1</div>
                        </div>
                        <div class="config-field">
                            <label>Center Y (meters)</label>
                            <input type="number" id="plantCenterY" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 2</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Plant Size</h4>
                        <div class="config-field">
                            <label>Radius (meters)</label>
                            <input type="number" id="plantRadius" step="0.05" min="0.1" max="2">
                        </div>
                        <div class="config-field">
                            <label>Height (z_max, meters)</label>
                            <input type="number" id="plantZMax" step="0.1" min="0.1" max="5">
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Wall Properties</h4>
                        <div class="config-field">
                            <label>Wall Thickness (meters)</label>
                            <input type="number" id="wallThickness" step="0.05" min="0" max="1">
                            <div class="value-display">0 = thin plane model</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Simulation</h4>
                        <div class="config-field">
                            <label>Angular Samples</label>
                            <input type="number" id="sampleAngular" step="1" min="4" max="16">
                        </div>
                        <div class="config-field">
                            <label>Vertical Samples</label>
                            <input type="number" id="sampleVertical" step="1" min="2" max="10">
                        </div>
                    </div>
                </div>
                <div class="config-actions">
                    <button class="btn-apply" onclick="applyConfig()">Apply Changes</button>
                    <button class="btn-reset" onclick="resetConfig()">Reset to Default</button>
                    <button class="btn-export" onclick="exportConfig()">Export JSON</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="time-display">Time: <span id="currentTime">--:--</span></div>
            <div id="statusDisplay" class="status miss">Loading...</div>
            <div class="info">
                <span id="sunInfo">Sun: Az --°, El --°</span>
                <span id="windowInfo" style="margin-left: 20px;"></span>
                <span id="hitPointsInfo" style="margin-left: 20px;"></span>
            </div>

            <div class="slider-container">
                <input type="range" id="timeSlider" min="0" max="137" value="0">
            </div>

            <div class="legend">
                <span class="legend-item"><span class="legend-color" style="background: #90EE90;"></span> Wall 1 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #87CEEB;"></span> Wall 2 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFC832;"></span> Window receiving sun</span>
                <span class="legend-item"><span class="legend-color" style="background: #228B22;"></span> Plant</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFD700;"></span> Sun rays through window</span>
                <span class="legend-item"><span class="legend-color" style="background: #FF4500;"></span> Ray hitting plant</span>
            </div>
        </div>

        <div class="plot-container">
            <div id="plot3d" style="width: 100%; height: 700px;"></div>
        </div>
    </div>

    <script>
        // Original config from file (immutable)
        const originalConfig = {"plant": {"center_x": 3.9, "center_y": 8.0, "radius": 0.3, "z_min": 0.0, "z_max": 1.2}, "walls": [{"id": "wall_1", "normal_azimuth": 210, "thickness": 0.3}, {"id": "wall_2", "normal_azimuth": 300, "thickness": 0.3}], "windows": [{"id": "window_1a", "wall_id": "wall_1", "center": [2.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1b", "wall_id": "wall_1", "center": [5.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1c", "wall_id": "wall_1", "center": [8.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1d", "wall_id": "wall_1", "center": [11.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_2a", "wall_id": "wall_2", "center": [0.0, 2.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2b", "wall_id": "wall_2", "center": [0.0, 5.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2c", "wall_id": "wall_2", "center": [0.0, 8.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2d", "wall_id": "wall_2", "center": [0.0, 11.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}]};
        const sunPositions = [{"timestamp": "06:55", "azimuth": 107.3, "elevation": -4.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:00", "azimuth": 107.9, "elevation": -3.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:05", "azimuth": 108.4, "elevation": -2.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:10", "azimuth": 109.0, "elevation": -1.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:15", "azimuth": 109.6, "elevation": -0.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:20", "azimuth": 110.2, "elevation": 0.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9853538679431869, 0.17020016647119748, 0.010471784116245792]}, {"timestamp": "07:25", "azimuth": 110.8, "elevation": 1.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9867513954901151, 0.1598188524214236, 0.02792163872356888]}, {"timestamp": "07:30", "azimuth": 111.4, "elevation": 2.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9876587378318937, 0.1493693405148821, 0.047106450709642665]}, {"timestamp": "07:35", "azimuth": 112.0, "elevation": 3.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9882039720734408, 0.13888301109142012, 0.06453230825295798]}, {"timestamp": "07:40", "azimuth": 112.7, "elevation": 4.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9885590852622602, 0.12663733947350647, 0.08193850863004093]}, {"timestamp": "07:45", "azimuth": 113.3, "elevation": 5.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9882599867452796, 0.11609386680217347, 0.09931974974363901]}, {"timestamp": "07:50", "azimuth": 113.9, "elevation": 6.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9875472618355378, 0.10553835675161063, 0.11667073709933316]}, {"timestamp": "07:55", "azimuth": 114.6, "elevation": 7.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9865851811967488, 0.09325975745214785, 0.13398618541829205]}, {"timestamp": "08:00", "azimuth": 115.2, "elevation": 8.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.985027099616641, 0.08271503659532857, 0.1512608202472192]}, {"timestamp": "08:05", "azimuth": 115.9, "elevation": 9.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9831808399457336, 0.07047527890971553, 0.16848937956500257]}, {"timestamp": "08:10", "azimuth": 116.6, "elevation": 10.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9808832289373881, 0.05827520159233616, 0.1856666153855772]}, {"timestamp": "08:15", "azimuth": 117.3, "elevation": 11.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9781357508618844, 0.04612771106231198, 0.20278729535651246]}, {"timestamp": "08:20", "azimuth": 118.0, "elevation": 12.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9749402746597461, 0.03404566459961432, 0.2198462043528375]}, {"timestamp": "08:25", "azimuth": 118.7, "elevation": 13.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9717108268782966, 0.022051203439859796, 0.23514211310259]}, {"timestamp": "08:30", "azimuth": 119.4, "elevation": 14.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.967656110374154, 0.010133641520598357, 0.25206935824311366]}, {"timestamp": "08:35", "azimuth": 120.2, "elevation": 15.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9631566988816977, -0.0033620647768827137, 0.2689198206152657]}, {"timestamp": "08:40", "azimuth": 120.9, "elevation": 16.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9587014476569675, -0.015060485820410549, 0.28401534470392265]}, {"timestamp": "08:45", "azimuth": 121.7, "elevation": 17.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9538203292920049, -0.02830872650162023, 0.29904079225608665]}, {"timestamp": "08:50", "azimuth": 122.5, "elevation": 18.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9479728919351205, -0.041389390313596265, 0.31564903694710245]}, {"timestamp": "08:55", "azimuth": 123.3, "elevation": 19.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9422359565256498, -0.05432898342140219, 0.330514392713223]}, {"timestamp": "09:00", "azimuth": 124.1, "elevation": 20.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9360912153965196, -0.06709985265136542, 0.34529819899853464]}, {"timestamp": "09:05", "azimuth": 124.9, "elevation": 21.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9295438659880549, -0.07969002037492424, 0.3599968081200512]}, {"timestamp": "09:10", "azimuth": 125.7, "elevation": 22.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9225994588648014, -0.09208766840191589, 0.374606593415912]}, {"timestamp": "09:15", "azimuth": 126.6, "elevation": 22.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9150804939575433, -0.10587842559133956, 0.38912395014020623]}, {"timestamp": "09:20", "azimuth": 127.5, "elevation": 23.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9071320610539971, -0.1194262014793608, 0.40354529635239006]}, {"timestamp": "09:25", "azimuth": 128.4, "elevation": 24.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8987620042978129, -0.13271762604682077, 0.41786707380107674]}, {"timestamp": "09:30", "azimuth": 129.3, "elevation": 25.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8907214474053236, -0.14586123082260147, 0.43051109680829514]}, {"timestamp": "09:35", "azimuth": 130.2, "elevation": 26.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8815555804340289, -0.15861688446319305, 0.44463517918492745]}, {"timestamp": "09:40", "azimuth": 131.2, "elevation": 27.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8724775766320794, -0.17275521223065538, 0.4570979270586942]}, {"timestamp": "09:45", "azimuth": 132.2, "elevation": 28.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8630070110819638, -0.1865887203416879, 0.4694715627858908]}, {"timestamp": "09:50", "azimuth": 133.2, "elevation": 28.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8531536961375262, -0.20010539287179607, 0.4817536741017153]}, {"timestamp": "09:55", "azimuth": 134.2, "elevation": 29.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8429278161662362, -0.21329352819179886, 0.493941866584231]}, {"timestamp": "10:00", "azimuth": 135.2, "elevation": 30.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8323399174928385, -0.22614175049596924, 0.5060337641211637]}, {"timestamp": "10:05", "azimuth": 136.3, "elevation": 31.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8209831434684948, -0.2400722718277141, 0.5180270093731302]}, {"timestamp": "10:10", "azimuth": 137.4, "elevation": 31.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.81012302210425, -0.25387716607160554, 0.5284383347223471]}, {"timestamp": "10:15", "azimuth": 138.5, "elevation": 32.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7980245806297996, -0.26701528952633585, 0.540240320477655]}, {"timestamp": "10:20", "azimuth": 139.6, "elevation": 33.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7864746515308422, -0.28005102623435596, 0.5504807400849955]}, {"timestamp": "10:25", "azimuth": 140.8, "elevation": 34.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7740920624101834, -0.29404999011845967, 0.5606389945632417]}, {"timestamp": "10:30", "azimuth": 141.9, "elevation": 34.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7618920060946767, -0.3062786226786596, 0.5707135676844316]}, {"timestamp": "10:35", "azimuth": 143.2, "elevation": 35.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7492127630633362, -0.32111300040996926, 0.5792811723426788]}, {"timestamp": "10:40", "azimuth": 144.4, "elevation": 36.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7358231853626164, -0.33378420029169364, 0.5891963573533421]}, {"timestamp": "10:45", "azimuth": 145.6, "elevation": 36.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7230673548584325, -0.34643582961425395, 0.597625146975521]}, {"timestamp": "10:50", "azimuth": 146.9, "elevation": 37.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7094012850928567, -0.3598998130758168, 0.605988400265711]}, {"timestamp": "10:55", "azimuth": 148.2, "elevation": 37.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6954225279343581, -0.37288228783463057, 0.6142852000989432]}, {"timestamp": "11:00", "azimuth": 149.6, "elevation": 38.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.680473824172599, -0.3865629337997258, 0.6225146366376195]}, {"timestamp": "11:05", "azimuth": 150.9, "elevation": 39.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6658981871167288, -0.39853184354019844, 0.6306758074312863]}, {"timestamp": "11:10", "azimuth": 152.3, "elevation": 39.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6512854361103805, -0.4117255615132168, 0.6374239897486897]}, {"timestamp": "11:15", "azimuth": 153.7, "elevation": 40.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.636379512599913, -0.4244123767353087, 0.6441236297613865]}, {"timestamp": "11:20", "azimuth": 155.2, "elevation": 40.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6213618554536625, -0.4383225719801539, 0.6494480483301837]}, {"timestamp": "11:25", "azimuth": 156.6, "elevation": 41.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6058940396969918, -0.4499766251036745, 0.6560590289905073]}, {"timestamp": "11:30", "azimuth": 158.1, "elevation": 41.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5902886710530879, -0.46284544030219354, 0.6613118653236518]}, {"timestamp": "11:35", "azimuth": 159.6, "elevation": 41.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5743991299271655, -0.47518428597974305, 0.6665324702494524]}, {"timestamp": "11:40", "azimuth": 161.1, "elevation": 42.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5582432246104889, -0.4869866035693981, 0.6717205893229902]}, {"timestamp": "11:45", "azimuth": 162.7, "elevation": 42.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5418358754950531, -0.4999917553323639, 0.6755902076156602]}, {"timestamp": "11:50", "azimuth": 164.2, "elevation": 42.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5260187230120636, -0.5115308564536135, 0.6794413042615165]}, {"timestamp": "11:55", "azimuth": 165.8, "elevation": 43.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5090436586808296, -0.5234610814156436, 0.6832737736807991]}, {"timestamp": "12:00", "azimuth": 167.4, "elevation": 43.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4918009349603395, -0.5348294988767148, 0.687087510804423]}, {"timestamp": "12:05", "azimuth": 169.0, "elevation": 43.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4750994882369131, -0.5465394415546145, 0.6896195437356698]}, {"timestamp": "12:10", "azimuth": 170.7, "elevation": 43.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4571491231008004, -0.5585270862838876, 0.6921431738704067]}, {"timestamp": "12:15", "azimuth": 172.3, "elevation": 44.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.43989573898896217, -0.5691585782280765, 0.6946583704589973]}, {"timestamp": "12:20", "azimuth": 174.0, "elevation": 44.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4221040471085957, -0.5809763789979835, 0.6959127965923144]}, {"timestamp": "12:25", "azimuth": 175.6, "elevation": 44.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.40503083772784465, -0.5915326194313082, 0.6971651028545646]}, {"timestamp": "12:30", "azimuth": 177.3, "elevation": 44.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3866460718196351, -0.6022631519716047, 0.6984152854310058]}, {"timestamp": "12:35", "azimuth": 178.9, "elevation": 44.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3696791501856578, -0.612824130558137, 0.6984152854310058]}, {"timestamp": "12:40", "azimuth": 180.6, "elevation": 44.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3513362494102455, -0.6235213941210586, 0.6984152854310058]}, {"timestamp": "12:45", "azimuth": 182.3, "elevation": 44.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3326840744450899, -0.6336697844200404, 0.6984152854310058]}, {"timestamp": "12:50", "azimuth": 183.9, "elevation": 44.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3153970575906529, -0.6438054950254329, 0.6971651028545646]}, {"timestamp": "12:55", "azimuth": 185.6, "elevation": 44.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.29666115477947136, -0.6539858857681675, 0.6959127965923144]}, {"timestamp": "13:00", "azimuth": 187.3, "elevation": 44.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.27759757543505437, -0.663618365074257, 0.6946583704589973]}, {"timestamp": "13:05", "azimuth": 188.9, "elevation": 43.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.2593961002922734, -0.6722407066646, 0.693401828275813]}, {"timestamp": "13:10", "azimuth": 190.5, "elevation": 43.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.2413313923052765, -0.6814988284308517, 0.6908824110768584]}, {"timestamp": "13:15", "azimuth": 192.2, "elevation": 43.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.22174353955902246, -0.6906502593826401, 0.6883545756937539]}, {"timestamp": "13:20", "azimuth": 193.8, "elevation": 43.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.20337576363219834, -0.7000239699693696, 0.6845471059286887]}, {"timestamp": "13:25", "azimuth": 195.3, "elevation": 42.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.1858885803164803, -0.7085651235219944, 0.6807208689589177]}, {"timestamp": "13:30", "azimuth": 196.9, "elevation": 42.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.16683736719614845, -0.7169408724387355, 0.6768759696826607]}, {"timestamp": "13:35", "azimuth": 198.5, "elevation": 42.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.14745872363661527, -0.7247827822752949, 0.6730125135097733]}, {"timestamp": "13:40", "azimuth": 200.0, "elevation": 41.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.12924834361949503, -0.733003781384945, 0.6678325554710467]}, {"timestamp": "13:45", "azimuth": 201.5, "elevation": 41.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.11053159540043542, -0.7395841740947983, 0.6639262126522416]}, {"timestamp": "13:50", "azimuth": 203.0, "elevation": 41.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.09183627583395623, -0.7479464450467705, 0.6573752457940958]}, {"timestamp": "13:55", "azimuth": 204.5, "elevation": 40.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.0726639559642844, -0.7546440361027676, 0.6520984038303922]}, {"timestamp": "14:00", "azimuth": 205.9, "elevation": 40.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.05460946403883199, -0.7618413088008832, 0.6454576877239506]}, {"timestamp": "14:05", "azimuth": 207.3, "elevation": 39.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.036243682215837444, -0.7685454253365883, 0.6387678175155977]}, {"timestamp": "14:10", "azimuth": 208.7, "elevation": 39.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.017581424115620248, -0.7747450252173608, 0.6320293026648509]}, {"timestamp": "14:15", "azimuth": 210.1, "elevation": 38.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.001362107327536978, -0.7804292186751464, 0.6252426563357052]}, {"timestamp": "14:20", "azimuth": 211.4, "elevation": 38.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.01922653665112152, -0.786700113815737, 0.6170358751407486]}, {"timestamp": "14:25", "azimuth": 212.8, "elevation": 37.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.03875512803980763, -0.792406185363213, 0.6087614290087207]}, {"timestamp": "14:30", "azimuth": 214.1, "elevation": 36.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.057175409353883606, -0.7976380918592282, 0.600420225325884]}, {"timestamp": "14:35", "azimuth": 215.3, "elevation": 36.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.07444406887109396, -0.802482695600322, 0.5920131787992196]}, {"timestamp": "14:40", "azimuth": 216.6, "elevation": 35.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.09333856654314127, -0.8067016590070374, 0.5835412113561176]}, {"timestamp": "14:45", "azimuth": 217.8, "elevation": 35.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.11117168860141143, -0.8115731188970869, 0.573576436351046]}, {"timestamp": "14:50", "azimuth": 219.0, "elevation": 34.3, "is_hit": true, "window_id": "window_1a", "hit_points": [[3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0]], "sun_direction": [-0.12923024477009182, -0.8159276536589944, 0.5635260489375714]}, {"timestamp": "14:55", "azimuth": 220.1, "elevation": 33.6, "is_hit": true, "window_id": "window_1a", "hit_points": [[3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.14606667107580606, -0.8200136101473461, 0.5533915492433441]}, {"timestamp": "15:00", "azimuth": 221.3, "elevation": 32.9, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.1645202750849433, -0.823343546769367, 0.5431744499506707]}, {"timestamp": "15:05", "azimuth": 222.4, "elevation": 32.2, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.18170756637493565, -0.8264534074726109, 0.53287627607073]}, {"timestamp": "15:10", "azimuth": 223.5, "elevation": 31.4, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6]], "sun_direction": [-0.19925747643943686, -0.8299671208019836, 0.5210096318405764]}, {"timestamp": "15:15", "azimuth": 224.6, "elevation": 30.7, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [3.9, 8.0, 0.6]], "sun_direction": [-0.21674241028530736, -0.8320869284840491, 0.5105429179116057]}, {"timestamp": "15:20", "azimuth": 225.6, "elevation": 29.9, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [3.9, 8.0, 0.6]], "sun_direction": [-0.2331257182157192, -0.8349624978533603, 0.49848773975383026]}, {"timestamp": "15:25", "azimuth": 226.6, "elevation": 29.1, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [3.9, 8.0, 0.6]], "sun_direction": [-0.24962655988281654, -0.8373556462754697, 0.4863353804234905]}, {"timestamp": "15:30", "azimuth": 227.6, "elevation": 28.3, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [3.9, 8.0, 0.6]], "sun_direction": [-0.26622984118880566, -0.8392627965679649, 0.4740882090471163]}, {"timestamp": "15:35", "azimuth": 228.6, "elevation": 27.5, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [4.112132034355964, 7.787867965644035, 1.2]], "sun_direction": [-0.28292036269043086, -0.8406808470226012, 0.4617486132350339]}, {"timestamp": "15:40", "azimuth": 229.6, "elevation": 26.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.29994544234660725, -0.8423446627558644, 0.4477590878387697]}, {"timestamp": "15:45", "azimuth": 230.5, "elevation": 25.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.31529827923150316, -0.8433035546307203, 0.4352310993723275]}, {"timestamp": "15:50", "azimuth": 231.4, "elevation": 24.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.33095930318735584, -0.8445086047493627, 0.421035813367491]}, {"timestamp": "15:55", "azimuth": 232.3, "elevation": 24.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.34638055117966965, -0.8445630520507006, 0.40833046038138493]}, {"timestamp": "16:00", "azimuth": 233.2, "elevation": 23.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.36208593071873335, -0.844809771867835, 0.3939419095909511]}, {"timestamp": "16:05", "azimuth": 234.1, "elevation": 22.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.37779131025779783, -0.8445630520507007, 0.3794561595290051]}, {"timestamp": "16:10", "azimuth": 234.9, "elevation": 21.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.3920078427222125, -0.8445086047493627, 0.3648767843376196]}, {"timestamp": "16:15", "azimuth": 235.8, "elevation": 20.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.40766886667806507, -0.84330355463072, 0.35020738125946743]}, {"timestamp": "16:20", "azimuth": 236.6, "elevation": 19.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4218147857517547, -0.8423446627558644, 0.33545156975025503]}, {"timestamp": "16:25", "azimuth": 237.4, "elevation": 18.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.43590596596377473, -0.8409478575422483, 0.32061299058567627]}, {"timestamp": "16:30", "azimuth": 238.2, "elevation": 17.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.45018091162766805, -0.8395838520781346, 0.30403306092549026]}, {"timestamp": "16:35", "azimuth": 239.0, "elevation": 16.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4641177020529356, -0.8372904985703302, 0.2890317969444716]}, {"timestamp": "16:40", "azimuth": 239.7, "elevation": 15.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.47650306860569175, -0.8353988102115009, 0.27395921869243245]}, {"timestamp": "16:45", "azimuth": 240.5, "elevation": 14.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.49047293330313113, -0.8326578098964103, 0.2571327931546962]}, {"timestamp": "16:50", "azimuth": 241.2, "elevation": 13.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5028573559011572, -0.8303161850907395, 0.24022804247726373]}, {"timestamp": "16:55", "azimuth": 241.9, "elevation": 13.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5148944944384151, -0.8272125982760371, 0.224951054343865]}, {"timestamp": "17:00", "azimuth": 242.6, "elevation": 12.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5269973506999321, -0.824042790864985, 0.20791169081775934]}, {"timestamp": "17:05", "azimuth": 243.3, "elevation": 11.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5389357224800055, -0.820451226044759, 0.1908089953765448]}, {"timestamp": "17:10", "azimuth": 244.0, "elevation": 10.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5506975067673986, -0.816442628990626, 0.17364817766693033]}, {"timestamp": "17:15", "azimuth": 244.7, "elevation": 9.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5621144613361945, -0.8117963772517379, 0.15815806725448353]}, {"timestamp": "17:20", "azimuth": 245.3, "elevation": 8.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5720927189315588, -0.8079955221311367, 0.14090123193758267]}, {"timestamp": "17:25", "azimuth": 246.0, "elevation": 7.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5832780784679006, -0.8028134018103851, 0.1236014767404927]}, {"timestamp": "17:30", "azimuth": 246.6, "elevation": 6.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5929586927165157, -0.7984195570618392, 0.10452846326765347]}, {"timestamp": "17:35", "azimuth": 247.3, "elevation": 5.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6036824314498, -0.7924464641002328, 0.08715574274765817]}, {"timestamp": "17:40", "azimuth": 247.9, "elevation": 4.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6127888322253684, -0.7871619156632607, 0.0697564737441253]}, {"timestamp": "17:45", "azimuth": 248.5, "elevation": 3.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6216615019633385, -0.7815356195726607, 0.052335956242943835]}, {"timestamp": "17:50", "azimuth": 249.1, "elevation": 2.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6302916167696891, -0.7755736605634331, 0.03489949670250097]}, {"timestamp": "17:55", "azimuth": 249.7, "elevation": 0.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6386890143151556, -0.7693046361331776, 0.015707317311820675]}, {"timestamp": "18:00", "azimuth": 250.3, "elevation": -0.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:05", "azimuth": 250.9, "elevation": -1.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:10", "azimuth": 251.5, "elevation": -2.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:15", "azimuth": 252.1, "elevation": -3.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:20", "azimuth": 252.7, "elevation": -4.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}];

        // Active config (mutable, from localStorage or original)
        let config = JSON.parse(JSON.stringify(originalConfig));
        let results = [];  // Will be recalculated

        // Simulation settings
        let simSettings = {
            sampleAngular: 8,
            sampleVertical: 3
        };

        let currentIndex = 0;
        const STORAGE_KEY = 'sunPlantSimulator_config';

        // Room offset - moves room away from origin so sun can be rendered in all directions
        const ROOM_OFFSET_X = 30;
        const ROOM_OFFSET_Y = 30;

        // ========== CONFIG PANEL FUNCTIONS ==========

        function toggleConfig() {
            const body = document.getElementById('configBody');
            const toggle = document.getElementById('configToggle');
            body.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function loadConfigFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge saved config into active config
                    if (parsed.plant) {
                        config.plant = { ...config.plant, ...parsed.plant };
                    }
                    if (parsed.wallThickness !== undefined) {
                        config.windows.forEach(w => w.wall_thickness = parsed.wallThickness);
                    }
                    if (parsed.simulation) {
                        simSettings = { ...simSettings, ...parsed.simulation };
                    }
                    console.log('Loaded config from localStorage:', parsed);
                }
            } catch (e) {
                console.warn('Failed to load config from localStorage:', e);
            }
        }

        function saveConfigToStorage() {
            try {
                const toSave = {
                    plant: {
                        center_x: config.plant.center_x,
                        center_y: config.plant.center_y,
                        radius: config.plant.radius,
                        z_max: config.plant.z_max
                    },
                    wallThickness: config.windows[0]?.wall_thickness || 0,
                    simulation: simSettings
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));

                // Show saved indicator
                const indicator = document.getElementById('savedIndicator');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            } catch (e) {
                console.warn('Failed to save config to localStorage:', e);
            }
        }

        function populateConfigFields() {
            document.getElementById('plantCenterX').value = config.plant.center_x;
            document.getElementById('plantCenterY').value = config.plant.center_y;
            document.getElementById('plantRadius').value = config.plant.radius;
            document.getElementById('plantZMax').value = config.plant.z_max;
            document.getElementById('wallThickness').value = config.windows[0]?.wall_thickness || 0;
            document.getElementById('sampleAngular').value = simSettings.sampleAngular;
            document.getElementById('sampleVertical').value = simSettings.sampleVertical;
        }

        function applyConfig() {
            // Read values from inputs
            config.plant.center_x = parseFloat(document.getElementById('plantCenterX').value);
            config.plant.center_y = parseFloat(document.getElementById('plantCenterY').value);
            config.plant.radius = parseFloat(document.getElementById('plantRadius').value);
            config.plant.z_max = parseFloat(document.getElementById('plantZMax').value);

            const thickness = parseFloat(document.getElementById('wallThickness').value);
            config.windows.forEach(w => w.wall_thickness = thickness);

            simSettings.sampleAngular = parseInt(document.getElementById('sampleAngular').value);
            simSettings.sampleVertical = parseInt(document.getElementById('sampleVertical').value);

            // Save and recalculate
            saveConfigToStorage();
            recalculateAllResults();
            updatePlot(currentIndex);
        }

        function resetConfig() {
            if (confirm('Reset all settings to default values?')) {
                localStorage.removeItem(STORAGE_KEY);
                config = JSON.parse(JSON.stringify(originalConfig));
                simSettings = { sampleAngular: 8, sampleVertical: 3 };
                populateConfigFields();
                recalculateAllResults();
                updatePlot(currentIndex);
            }
        }

        function exportConfig() {
            const exportData = {
                plant: config.plant,
                windows: config.windows.map(w => ({
                    id: w.id,
                    center: w.center,
                    width: w.width,
                    height: w.height,
                    wall_thickness: w.wall_thickness
                })),
                simulation: simSettings
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sun_plant_config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== RAY CASTING (JavaScript implementation) ==========

        function generatePlantSamplePoints() {
            const points = [];
            const plant = config.plant;
            const nAngular = simSettings.sampleAngular;
            const nVertical = simSettings.sampleVertical;

            for (let vi = 0; vi < nVertical; vi++) {
                const z = plant.z_min + (plant.z_max - plant.z_min) * (vi + 0.5) / nVertical;
                for (let ai = 0; ai < nAngular; ai++) {
                    const angle = (2 * Math.PI * ai) / nAngular;
                    const x = plant.center_x + plant.radius * Math.cos(angle);
                    const y = plant.center_y + plant.radius * Math.sin(angle);
                    points.push([x, y, z]);
                }
            }
            return points;
        }

        function sunDirectionFromAngles(azimuthDeg, elevationDeg) {
            const azRad = azimuthDeg * Math.PI / 180;
            const elRad = elevationDeg * Math.PI / 180;
            return [
                Math.sin(azRad) * Math.cos(elRad),
                Math.cos(azRad) * Math.cos(elRad),
                Math.sin(elRad)
            ];
        }

        function rayIntersectsWindowTunnel(origin, direction, window) {
            // Check sun is on correct side of wall
            const azRad = window.wall_normal_azimuth * Math.PI / 180;
            const wallNormal = [Math.sin(azRad), Math.cos(azRad), 0];
            const sunSideCheck = direction[0]*wallNormal[0] + direction[1]*wallNormal[1];
            if (sunSideCheck <= 0) return false;

            // Determine plane axis (wall 1 at y=0, wall 2 at x=0)
            const isWall1 = Math.abs(window.center[1]) < Math.abs(window.center[0]);
            const planeAxis = isWall1 ? 1 : 0;
            const innerCoord = window.center[planeAxis];
            const thickness = window.wall_thickness || 0;
            const outerCoord = innerCoord - thickness;

            // Helper to check intersection with axis-aligned plane
            function checkPlaneIntersection(planeCoord) {
                if (Math.abs(direction[planeAxis]) < 1e-10) return null;
                const t = (planeCoord - origin[planeAxis]) / direction[planeAxis];
                if (t < 0) return null;

                const intersection = [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];

                // Check bounds
                const localH = isWall1
                    ? intersection[0] - window.center[0]
                    : intersection[1] - window.center[1];
                const localV = intersection[2] - window.center[2];

                const withinH = Math.abs(localH) <= window.width / 2 + 1e-6;
                const withinV = Math.abs(localV) <= window.height / 2 + 1e-6;

                return withinH && withinV ? intersection : null;
            }

            // Check inner plane
            const innerHit = checkPlaneIntersection(innerCoord);
            if (!innerHit) return false;

            // If no thickness, single plane is enough
            if (thickness <= 0) return true;

            // Check outer plane for tunnel model
            const outerHit = checkPlaneIntersection(outerCoord);
            return outerHit !== null;
        }

        function checkSunHitsPlant(azimuthDeg, elevationDeg) {
            if (elevationDeg <= 0) {
                return { is_hit: false, reason: 'sun_below_horizon', sun_direction: null, window_id: null, hit_points: [] };
            }

            const sunDir = sunDirectionFromAngles(azimuthDeg, elevationDeg);
            const samplePoints = generatePlantSamplePoints();
            const hitPoints = [];
            let hitWindowId = null;

            for (const pt of samplePoints) {
                for (const window of config.windows) {
                    if (rayIntersectsWindowTunnel(pt, sunDir, window)) {
                        hitPoints.push(pt);
                        if (!hitWindowId) hitWindowId = window.id;
                        break;
                    }
                }
            }

            return {
                is_hit: hitPoints.length > 0,
                window_id: hitWindowId,
                hit_points: hitPoints,
                sun_direction: sunDir,
                reason: hitPoints.length === 0 ? 'no_window_path' : null
            };
        }

        function recalculateAllResults() {
            results = sunPositions.map(sp => {
                const hit = checkSunHitsPlant(sp.azimuth, sp.elevation);
                return {
                    timestamp: sp.timestamp,
                    azimuth: sp.azimuth,
                    elevation: sp.elevation,
                    ...hit
                };
            });
        }

        // Check if sun shines into a window based on wall normal azimuth
        // Sun shines through window if sun direction is opposite to outward normal
        function windowReceivesSun(wallNormalAzimuth, sunDir) {
            if (!sunDir) return false;

            // Convert wall normal azimuth to direction vector
            const azRad = wallNormalAzimuth * Math.PI / 180;
            const outwardNormal = [Math.sin(azRad), Math.cos(azRad), 0];

            // Inward normal is opposite of outward
            const inwardNormal = [-outwardNormal[0], -outwardNormal[1], 0];

            // Sun shines through if sun direction has component INTO the room
            // (dot product of sun direction and inward normal > 0)
            // But sun_direction points TOWARD sun, so light comes FROM opposite direction
            // Light direction = -sunDir, so we check if -sunDir dot inwardNormal > 0
            // Which is equivalent to: sunDir dot inwardNormal < 0
            // Or: sunDir dot outwardNormal > 0 (sun is on the outside)
            const dot = sunDir[0] * outwardNormal[0] + sunDir[1] * outwardNormal[1];
            return dot > 0.1;  // Sun is in direction of outward normal (outside the room)
        }

        function createPlotData(index) {
            const result = results[index];
            const traces = [];
            const sunDir = result.sun_direction;
            const wallThickness = config.windows[0]?.wall_thickness || 0;
            const wallHeight = 6;
            const wallLength = 15;

            // Get wall info
            const wall1 = config.walls?.find(w => w.id === 'wall_1') || { normal_azimuth: 210, thickness: 0.3 };
            const wall2 = config.walls?.find(w => w.id === 'wall_2') || { normal_azimuth: 300, thickness: 0.3 };

            // ========== COMPASS (ENU: X=East, Y=North) ==========
            const compassCenter = [ROOM_OFFSET_X - 3, ROOM_OFFSET_Y - 3, 0.1];
            const compassLen = 2;
            // North arrow (Y+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0]],
                y: [compassCenter[1], compassCenter[1] + compassLen],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'red', width: 5 },
                text: ['', 'N'],
                textposition: 'top center',
                textfont: { size: 16, color: 'red' },
                name: 'North',
                showlegend: false,
            });
            // East arrow (X+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0] + compassLen],
                y: [compassCenter[1], compassCenter[1]],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'blue', width: 5 },
                text: ['', 'E'],
                textposition: 'middle right',
                textfont: { size: 16, color: 'blue' },
                name: 'East',
                showlegend: false,
            });

            // ========== WALL GEOMETRY (simplified axis-aligned) ==========
            // In the simplified coordinate system:
            // - Wall 1 runs along the X axis at y=0 (normal points -Y, azimuth 180° in simplified)
            // - Wall 2 runs along the Y axis at x=0 (normal points -X, azimuth 270° in simplified)
            // The actual wall azimuths (210°, 300°) define the real-world orientation
            // but the coordinates use simplified axis-aligned geometry

            // Simplified wall normals (axis-aligned)
            const wall1Normal = [0, -1];  // Wall 1 at y=0, normal points -Y
            const wall2Normal = [-1, 0];  // Wall 2 at x=0, normal points -X

            // Wall directions (perpendicular to normal, along the wall)
            const wall1Dir = [1, 0];   // Wall 1 runs along +X
            const wall2Dir = [0, 1];   // Wall 2 runs along +Y

            // Corner is at origin in simplified coords, offset for visualization
            const plant = config.plant;
            const plantVizX = ROOM_OFFSET_X;
            const plantVizY = ROOM_OFFSET_Y;
            // In simplified coords, plant.center_x is distance from wall_2 (x=0)
            // and plant.center_y is distance from wall_1 (y=0)
            // So corner in viz coords = plant viz position - plant simplified coords
            const cornerX = plantVizX - plant.center_x;
            const cornerY = plantVizY - plant.center_y;

            // ========== WALL 1 (at y=0, runs along X) ==========
            // Wall runs from corner along wall1Dir
            const w1InnerStart = [cornerX, cornerY];
            const w1InnerEnd = [cornerX + wallLength * wall1Dir[0], cornerY + wallLength * wall1Dir[1]];
            const w1OuterStart = [cornerX - wallThickness * wall1Normal[0], cornerY - wallThickness * wall1Normal[1]];
            const w1OuterEnd = [w1InnerEnd[0] - wallThickness * wall1Normal[0], w1InnerEnd[1] - wallThickness * wall1Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 1 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w1OuterStart[0], w1OuterEnd[0], w1OuterEnd[0], w1OuterStart[0]],
                    y: [w1OuterStart[1], w1OuterEnd[1], w1OuterEnd[1], w1OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 1 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 1 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#2E7D32', width: 4 },
                name: `Wall 1 (azimuth ${wall1.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== WALL 2 (normal at azimuth ${wall2.normal_azimuth}°) ==========
            // Wall runs from corner along wall2Dir
            const w2InnerStart = [cornerX, cornerY];
            const w2InnerEnd = [cornerX + wallLength * wall2Dir[0], cornerY + wallLength * wall2Dir[1]];
            const w2OuterStart = [cornerX - wallThickness * wall2Normal[0], cornerY - wallThickness * wall2Normal[1]];
            const w2OuterEnd = [w2InnerEnd[0] - wallThickness * wall2Normal[0], w2InnerEnd[1] - wallThickness * wall2Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 2 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w2OuterStart[0], w2OuterEnd[0], w2OuterEnd[0], w2OuterStart[0]],
                    y: [w2OuterStart[1], w2OuterEnd[1], w2OuterEnd[1], w2OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 2 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 2 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#1565C0', width: 4 },
                name: `Wall 2 (azimuth ${wall2.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== FLOOR (triangular, bounded by rotated walls) ==========
            // Floor is the area between the two walls and extending inward
            const floorCorners = [
                [cornerX, cornerY],  // Corner
                [w1InnerEnd[0], w1InnerEnd[1]],  // End of wall 1
                [cornerX + wallLength * wall1Dir[0] + wallLength * wall2Dir[0],
                 cornerY + wallLength * wall1Dir[1] + wallLength * wall2Dir[1]],  // Far corner
                [w2InnerEnd[0], w2InnerEnd[1]],  // End of wall 2
            ];
            traces.push({
                type: 'mesh3d',
                x: floorCorners.map(c => c[0]),
                y: floorCorners.map(c => c[1]),
                z: [0, 0, 0, 0],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(200, 180, 160, 0.3)',
                name: 'Floor',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Add windows with sun exposure coloring (positioned on rotated walls)
            config.windows.forEach((w, i) => {
                const isWall1 = w.wall_id === 'wall_1' || w.id.startsWith('window_1');
                const receivesSun = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                const thickness = w.wall_thickness || 0;

                // Colors: bright yellow/orange if receiving sun, otherwise default
                let color, frameColor, outerColor;
                if (receivesSun) {
                    color = 'rgba(255, 200, 50, 0.8)';  // Bright yellow - sun hitting
                    outerColor = 'rgba(255, 220, 100, 0.6)';
                    frameColor = '#FF8C00';  // Dark orange frame
                } else {
                    color = isWall1 ? 'rgba(144, 238, 144, 0.5)' : 'rgba(135, 206, 235, 0.5)';
                    outerColor = isWall1 ? 'rgba(144, 238, 144, 0.3)' : 'rgba(135, 206, 235, 0.3)';
                    frameColor = isWall1 ? '#228B22' : '#4169E1';
                }

                // Window position along wall (from config x_position or y_position)
                const wallPos = isWall1 ? (w.center[0] || 0) : (w.center[1] || 0);
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallNormal = isWall1 ? wall1Normal : wall2Normal;

                // Window center on wall (in world coordinates)
                const windowCenterX = cornerX + wallPos * wallDir[0];
                const windowCenterY = cornerY + wallPos * wallDir[1];

                // Window corners (perpendicular to wall = along wallDir, vertical = Z)
                const halfW = w.width / 2;
                const halfH = w.height / 2;
                const wz = w.center[2];

                let innerCorners = [
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz + halfH],
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz + halfH],
                ];

                // Outer corners (offset by wall thickness in outward normal direction)
                let outerCorners = innerCorners.map(c => [
                    c[0] - thickness * wallNormal[0],
                    c[1] - thickness * wallNormal[1],
                    c[2]
                ]);

                // Inner window mesh
                traces.push({
                    type: 'mesh3d',
                    x: innerCorners.map(c => c[0]),
                    y: innerCorners.map(c => c[1]),
                    z: innerCorners.map(c => c[2]),
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: color,
                    name: w.id + ' (inner)',
                    showlegend: false,
                    hoverinfo: 'name',
                });

                // Inner window frame
                const innerFrameX = [...innerCorners.map(c => c[0]), innerCorners[0][0]];
                const innerFrameY = [...innerCorners.map(c => c[1]), innerCorners[0][1]];
                const innerFrameZ = [...innerCorners.map(c => c[2]), innerCorners[0][2]];
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: innerFrameX,
                    y: innerFrameY,
                    z: innerFrameZ,
                    line: { color: frameColor, width: 3 },
                    name: w.id,
                    showlegend: i === 0,
                });

                // Outer window (only if wall has thickness)
                if (thickness > 0) {
                    // Outer window mesh
                    traces.push({
                        type: 'mesh3d',
                        x: outerCorners.map(c => c[0]),
                        y: outerCorners.map(c => c[1]),
                        z: outerCorners.map(c => c[2]),
                        i: [0, 0],
                        j: [1, 2],
                        k: [2, 3],
                        color: outerColor,
                        name: w.id + ' (outer)',
                        showlegend: false,
                        hoverinfo: 'name',
                    });

                    // Outer window frame
                    const outerFrameX = [...outerCorners.map(c => c[0]), outerCorners[0][0]];
                    const outerFrameY = [...outerCorners.map(c => c[1]), outerCorners[0][1]];
                    const outerFrameZ = [...outerCorners.map(c => c[2]), outerCorners[0][2]];
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: outerFrameX,
                        y: outerFrameY,
                        z: outerFrameZ,
                        line: { color: frameColor, width: 2, dash: 'dot' },
                        name: w.id + ' outer frame',
                        showlegend: false,
                    });

                    // Tunnel edges (connect inner to outer corners)
                    for (let ci = 0; ci < 4; ci++) {
                        traces.push({
                            type: 'scatter3d',
                            mode: 'lines',
                            x: [innerCorners[ci][0], outerCorners[ci][0]],
                            y: [innerCorners[ci][1], outerCorners[ci][1]],
                            z: [innerCorners[ci][2], outerCorners[ci][2]],
                            line: { color: frameColor, width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip',
                        });
                    }
                }
            });

            // Add plant cylinder
            // Plant is positioned at the room offset center (plantVizX, plantVizY)
            // This was calculated earlier: corner + plant.center = plantViz position
            const plantX = plantVizX;
            const plantY = plantVizY;
            const nPts = 20;
            const theta = Array.from({length: nPts}, (_, i) => 2 * Math.PI * i / nPts);

            // Bottom circle
            const xBottom = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yBottom = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zBottom = theta.map(() => plant.z_min);

            // Top circle
            const xTop = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yTop = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zTop = theta.map(() => plant.z_max);

            // Combine for mesh
            const allX = [...xBottom, ...xTop];
            const allY = [...yBottom, ...yTop];
            const allZ = [...zBottom, ...zTop];

            const iIdx = [], jIdx = [], kIdx = [];
            for (let idx = 0; idx < nPts; idx++) {
                const next = (idx + 1) % nPts;
                iIdx.push(idx, next);
                jIdx.push(next, next + nPts);
                kIdx.push(idx + nPts, idx + nPts);
            }

            traces.push({
                type: 'mesh3d',
                x: allX,
                y: allY,
                z: allZ,
                i: iIdx,
                j: jIdx,
                k: kIdx,
                color: 'rgba(34, 139, 34, 0.8)',
                name: 'Plant',
                showlegend: true,
            });

            // Helper function to find ray-window intersection (with rotated walls)
            function rayWindowIntersection(origin, direction, window) {
                // Get actual wall normal from config azimuth
                const azRad = window.wall_normal_azimuth * Math.PI / 180;
                const normal = [Math.sin(azRad), Math.cos(azRad), 0];

                const isWall1 = window.id.startsWith('window_1');
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallPos = isWall1 ? (window.center[0] || 0) : (window.center[1] || 0);

                // Window center on wall (in world coordinates)
                const windowCenter = [
                    cornerX + wallPos * wallDir[0],
                    cornerY + wallPos * wallDir[1],
                    window.center[2]
                ];

                const denom = direction[0]*normal[0] + direction[1]*normal[1] + direction[2]*normal[2];
                if (Math.abs(denom) < 1e-10) return null;

                const diff = [
                    windowCenter[0] - origin[0],
                    windowCenter[1] - origin[1],
                    windowCenter[2] - origin[2]
                ];
                const t = (diff[0]*normal[0] + diff[1]*normal[1] + diff[2]*normal[2]) / denom;
                if (t < 0) return null;

                return [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];
            }

            // Draw sun rays from far away through windows that receive sunlight
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];

                // Draw rays through each window that receives sun
                config.windows.forEach((w, wIdx) => {
                    const receivesSunRay = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                    if (!receivesSunRay) return;

                    const isWall1 = w.id.startsWith('window_1');
                    const wallDir = isWall1 ? wall1Dir : wall2Dir;
                    const wallPos = isWall1 ? (w.center[0] || 0) : (w.center[1] || 0);

                    // Window center on rotated wall (in world coordinates)
                    const windowCenter = [
                        cornerX + wallPos * wallDir[0],
                        cornerY + wallPos * wallDir[1],
                        w.center[2]
                    ];

                    // Calculate sun position along the ray direction from window
                    const sunStart = [
                        windowCenter[0] + sunDist * sunDir[0],
                        windowCenter[1] + sunDist * sunDir[1],
                        windowCenter[2] + sunDist * sunDir[2]
                    ];

                    // Draw ray from far away (sun) through window into room
                    // Ray continues 10m past window into room (negative sun direction)
                    const roomEnd = [
                        windowCenter[0] - 10 * sunDir[0],
                        windowCenter[1] - 10 * sunDir[1],
                        windowCenter[2] - 10 * sunDir[2]
                    ];

                    // Only draw up to floor level (z >= 0)
                    if (roomEnd[2] < 0) {
                        const t = windowCenter[2] / (windowCenter[2] - roomEnd[2]);
                        roomEnd[0] = windowCenter[0] + t * (roomEnd[0] - windowCenter[0]);
                        roomEnd[1] = windowCenter[1] + t * (roomEnd[1] - windowCenter[1]);
                        roomEnd[2] = 0;
                    }

                    // Draw the incoming ray from sun to window (bright yellow)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [sunStart[0], windowCenter[0]],
                        y: [sunStart[1], windowCenter[1]],
                        z: [sunStart[2], windowCenter[2]],
                        line: { color: 'rgba(255, 215, 0, 0.6)', width: 3 },
                        name: wIdx === 0 ? 'Sun ray (incoming)' : '',
                        showlegend: wIdx === 0,
                    });

                    // Draw ray passing through window into room (brighter)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [windowCenter[0], roomEnd[0]],
                        y: [windowCenter[1], roomEnd[1]],
                        z: [windowCenter[2], roomEnd[2]],
                        line: { color: '#FFD700', width: 4 },
                        name: wIdx === 0 ? 'Sunlight in room' : '',
                        showlegend: wIdx === 0,
                    });

                    // Mark where light enters window
                    traces.push({
                        type: 'scatter3d',
                        mode: 'markers',
                        x: [windowCenter[0]],
                        y: [windowCenter[1]],
                        z: [windowCenter[2]],
                        marker: { size: 6, color: '#FF6600', symbol: 'circle' },
                        name: '',
                        showlegend: false,
                    });
                });

                // Also draw rays to plant hit points if plant is hit
                if (result.is_hit && result.hit_points) {
                    const hitWindow = config.windows.find(w => w.id === result.window_id);

                    result.hit_points.forEach((pt, i) => {
                        if (i < 3) { // Limit rays shown
                            // Convert hit point from ENU to visualization coordinates
                            const ptOffset = [pt[0] + cornerX, pt[1] + cornerY, pt[2]];

                            // Find window intersection for this ray
                            let windowPt = null;
                            if (hitWindow) {
                                windowPt = rayWindowIntersection(ptOffset, sunDir, hitWindow);
                            }

                            if (windowPt) {
                                // Draw ray from window to plant (showing light hitting plant)
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'lines',
                                    x: [windowPt[0], ptOffset[0]],
                                    y: [windowPt[1], ptOffset[1]],
                                    z: [windowPt[2], ptOffset[2]],
                                    line: { color: '#FF4500', width: 5 },
                                    name: i === 0 ? 'Ray hitting plant' : '',
                                    showlegend: i === 0,
                                });

                                // Mark hit point on plant
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'markers',
                                    x: [ptOffset[0]],
                                    y: [ptOffset[1]],
                                    z: [ptOffset[2]],
                                    marker: { size: 8, color: '#FF0000', symbol: 'diamond' },
                                    name: i === 0 ? 'Plant hit' : '',
                                    showlegend: i === 0,
                                });
                            }
                        }
                    });
                }
            }

            // Add sun indicator - far away so rays appear parallel (from "infinity")
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                // Sun very far away - rays will appear nearly parallel
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];
                const sunPos = [
                    roomCenter[0] + sunDist * sunDir[0],
                    roomCenter[1] + sunDist * sunDir[1],
                    Math.max(5, sunDist * sunDir[2]),
                ];

                // Sun marker (larger since it's further away)
                traces.push({
                    type: 'scatter3d',
                    mode: 'markers',
                    x: [sunPos[0]],
                    y: [sunPos[1]],
                    z: [sunPos[2]],
                    marker: { size: 25, color: '#FFD700', symbol: 'circle',
                              line: { color: '#FFA500', width: 3 } },
                    name: `Sun (El: ${result.elevation.toFixed(0)}°)`,
                    showlegend: true,
                });

                // Draw line from room center toward sun to show direction
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: [roomCenter[0], sunPos[0]],
                    y: [roomCenter[1], sunPos[1]],
                    z: [roomCenter[2], sunPos[2]],
                    line: { color: 'rgba(255, 215, 0, 0.4)', width: 3, dash: 'dot' },
                    name: 'Sun direction',
                    showlegend: false,
                });
            }

            return traces;
        }

        function updatePlot(index) {
            const result = results[index];
            const traces = createPlotData(index);

            // Update info displays
            document.getElementById('currentTime').textContent = result.timestamp;
            document.getElementById('sunInfo').textContent =
                `Sun: Az ${result.azimuth.toFixed(0)}°, El ${result.elevation.toFixed(0)}°`;

            const statusEl = document.getElementById('statusDisplay');
            if (result.is_hit) {
                statusEl.textContent = '☀️ SUNLIGHT HITTING PLANT';
                statusEl.className = 'status hit';
                document.getElementById('windowInfo').textContent = `Through: ${result.window_id}`;
                const totalSamples = simSettings.sampleAngular * simSettings.sampleVertical;
                const hitCount = result.hit_points ? result.hit_points.length : 0;
                document.getElementById('hitPointsInfo').textContent = `Hits: ${hitCount}/${totalSamples} (${Math.round(100*hitCount/totalSamples)}%)`;
            } else {
                statusEl.textContent = 'No direct sunlight';
                statusEl.className = 'status miss';
                document.getElementById('windowInfo').textContent = '';
                document.getElementById('hitPointsInfo').textContent = '';
            }

            Plotly.react('plot3d', traces, {
                scene: {
                    xaxis: { title: 'X (meters)', range: [-30, 120] },
                    yaxis: { title: 'Y (meters)', range: [-30, 120] },
                    zaxis: { title: 'Z (meters)', range: [0, 80] },
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 1.2, y: 1.2, z: 0.7 }
                    }
                },
                title: `Sun-Plant Simulation - ${result.timestamp}`,
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved config from localStorage
            loadConfigFromStorage();

            // Populate form fields with current config
            populateConfigFields();

            // Calculate initial results with current config
            recalculateAllResults();

            const slider = document.getElementById('timeSlider');

            slider.addEventListener('input', function() {
                currentIndex = parseInt(this.value);
                updatePlot(currentIndex);
            });

            // Auto-apply on Enter key in inputs
            document.querySelectorAll('.config-field input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyConfig();
                });
            });

            // Initial plot
            updatePlot(0);
        });
    </script>
</body>
</html>