<!DOCTYPE html>
<html>
<head>
    <title>Sun-Plant Simulation</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            font-size: 24px;
            padding: 10px 20px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 15px;
        }
        .status.hit {
            background: #4CAF50;
            color: white;
        }
        .status.miss {
            background: #9E9E9E;
            color: white;
        }
        .info {
            color: #666;
            font-size: 14px;
        }
        .slider-container {
            margin: 20px 0;
        }
        #timeSlider {
            width: 100%;
            height: 30px;
            cursor: pointer;
        }
        .plot-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
        /* Config panel styles */
        .config-panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-header {
            background: #f0f0f0;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .config-header:hover {
            background: #e8e8e8;
        }
        .config-toggle {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .config-toggle.open {
            transform: rotate(180deg);
        }
        .config-body {
            padding: 20px;
            display: none;
            border-top: 1px solid #ddd;
        }
        .config-body.open {
            display: block;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .config-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }
        .config-group h4 {
            margin: 0 0 12px 0;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
        }
        .config-field {
            margin-bottom: 12px;
        }
        .config-field:last-child {
            margin-bottom: 0;
        }
        .config-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .config-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .config-field input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .config-field .value-display {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        .config-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .config-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-apply {
            background: #4CAF50;
            color: white;
        }
        .btn-apply:hover {
            background: #45a049;
        }
        .btn-reset {
            background: #f44336;
            color: white;
        }
        .btn-reset:hover {
            background: #da190b;
        }
        .btn-export {
            background: #2196F3;
            color: white;
        }
        .btn-export:hover {
            background: #1976D2;
        }
        .saved-indicator {
            color: #4CAF50;
            font-size: 12px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .saved-indicator.show {
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sun Hits Indoor Plant - 3D Simulation</h1>
        <h2 style="color: #666; margin-top: 0;">Date: 2026-01-29</h2>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="config-header" onclick="toggleConfig()">
                <span>⚙️ Configuration <span class="saved-indicator" id="savedIndicator">✓ Saved</span></span>
                <span class="config-toggle" id="configToggle">▼</span>
            </div>
            <div class="config-body" id="configBody">
                <div class="config-grid">
                    <div class="config-group">
                        <h4>Plant Position</h4>
                        <div class="config-field">
                            <label>Center X (meters)</label>
                            <input type="number" id="plantCenterX" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 1</div>
                        </div>
                        <div class="config-field">
                            <label>Center Y (meters)</label>
                            <input type="number" id="plantCenterY" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 2</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Plant Size</h4>
                        <div class="config-field">
                            <label>Radius (meters)</label>
                            <input type="number" id="plantRadius" step="0.05" min="0.1" max="2">
                        </div>
                        <div class="config-field">
                            <label>Height (z_max, meters)</label>
                            <input type="number" id="plantZMax" step="0.1" min="0.1" max="5">
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Wall Properties</h4>
                        <div class="config-field">
                            <label>Wall Thickness (meters)</label>
                            <input type="number" id="wallThickness" step="0.05" min="0" max="1">
                            <div class="value-display">0 = thin plane model</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Simulation</h4>
                        <div class="config-field">
                            <label>Angular Samples</label>
                            <input type="number" id="sampleAngular" step="1" min="4" max="16">
                        </div>
                        <div class="config-field">
                            <label>Vertical Samples</label>
                            <input type="number" id="sampleVertical" step="1" min="2" max="10">
                        </div>
                    </div>
                </div>
                <div class="config-actions">
                    <button class="btn-apply" onclick="applyConfig()">Apply Changes</button>
                    <button class="btn-reset" onclick="resetConfig()">Reset to Default</button>
                    <button class="btn-export" onclick="exportConfig()">Export JSON</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="time-display">Time: <span id="currentTime">--:--</span></div>
            <div id="statusDisplay" class="status miss">Loading...</div>
            <div class="info">
                <span id="sunInfo">Sun: Az --°, El --°</span>
                <span id="windowInfo" style="margin-left: 20px;"></span>
                <span id="hitPointsInfo" style="margin-left: 20px;"></span>
            </div>

            <div class="slider-container">
                <input type="range" id="timeSlider" min="0" max="137" value="0">
            </div>

            <div class="legend">
                <span class="legend-item"><span class="legend-color" style="background: #90EE90;"></span> Wall 1 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #87CEEB;"></span> Wall 2 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFC832;"></span> Window receiving sun</span>
                <span class="legend-item"><span class="legend-color" style="background: #228B22;"></span> Plant</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFD700;"></span> Sun rays through window</span>
                <span class="legend-item"><span class="legend-color" style="background: #FF4500;"></span> Ray hitting plant</span>
            </div>
        </div>

        <div class="plot-container">
            <div id="plot3d" style="width: 100%; height: 700px;"></div>
        </div>
    </div>

    <script>
        // Original config from file (immutable)
        const originalConfig = {"plant": {"center_x": 7.38, "center_y": 4.98, "radius": 0.3, "z_min": 0.0, "z_max": 1.2}, "walls": [{"id": "wall_1", "normal_azimuth": 210, "thickness": 0.3}, {"id": "wall_2", "normal_azimuth": 300, "thickness": 0.3}], "windows": [{"id": "window_1a", "wall_id": "wall_1", "center": [2.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1b", "wall_id": "wall_1", "center": [5.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1c", "wall_id": "wall_1", "center": [8.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_1d", "wall_id": "wall_1", "center": [11.0, 0.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 210, "wall_thickness": 0.3}, {"id": "window_2a", "wall_id": "wall_2", "center": [0.0, 2.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2b", "wall_id": "wall_2", "center": [0.0, 5.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2c", "wall_id": "wall_2", "center": [0.0, 8.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}, {"id": "window_2d", "wall_id": "wall_2", "center": [0.0, 11.0, 4.95], "width": 1.5, "height": 1.5, "wall_normal_azimuth": 300, "wall_thickness": 0.3}]};
        const sunPositions = [{"timestamp": "06:55", "azimuth": 108.1, "elevation": -4.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:00", "azimuth": 108.7, "elevation": -3.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:05", "azimuth": 109.2, "elevation": -2.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:10", "azimuth": 109.8, "elevation": -1.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:15", "azimuth": 110.4, "elevation": -0.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:20", "azimuth": 111.0, "elevation": 0.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9335676292077081, -0.3583630371261177, 0.00523596383141958]}, {"timestamp": "07:25", "azimuth": 111.6, "elevation": 1.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9295371700888095, -0.36802980085673087, 0.022687333572781358]}, {"timestamp": "07:30", "azimuth": 112.2, "elevation": 2.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.925058439000647, -0.3775093562528463, 0.04187565372919962]}, {"timestamp": "07:35", "azimuth": 112.8, "elevation": 3.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9202405138109648, -0.3868334923377241, 0.05930637357596162]}, {"timestamp": "07:40", "azimuth": 113.4, "elevation": 4.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9150497754072003, -0.395977397398524, 0.07671902812681865]}, {"timestamp": "07:45", "azimuth": 114.1, "elevation": 5.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9087829868429642, -0.40651827534457163, 0.09410831331851433]}, {"timestamp": "07:50", "azimuth": 114.7, "elevation": 6.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.902846281121116, -0.41526289241702363, 0.11146893220632548]}, {"timestamp": "07:55", "azimuth": 115.3, "elevation": 7.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8965525929123721, -0.42379846913873104, 0.1287955965775628]}, {"timestamp": "08:00", "azimuth": 116.0, "elevation": 8.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.889152083035621, -0.4336684470876913, 0.14608302856241162]}, {"timestamp": "08:05", "azimuth": 116.7, "elevation": 9.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.881375341700414, -0.4432856157155638, 0.16332596224162227]}, {"timestamp": "08:10", "azimuth": 117.3, "elevation": 10.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8740185585125487, -0.45111461689204185, 0.18051914525055998]}, {"timestamp": "08:15", "azimuth": 118.0, "elevation": 11.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8658313522859105, -0.4603706962386312, 0.19594614424251772]}, {"timestamp": "08:20", "azimuth": 118.7, "elevation": 12.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8570117773814149, -0.4692002429166917, 0.21303038627497659]}, {"timestamp": "08:25", "azimuth": 119.5, "elevation": 13.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8470117750899098, -0.4792162051503728, 0.23004973718810443]}, {"timestamp": "08:30", "azimuth": 120.2, "elevation": 14.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.837867187785561, -0.4876503481651823, 0.24530738587880255]}, {"timestamp": "08:35", "azimuth": 120.9, "elevation": 15.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8280467873511458, -0.4955757788280971, 0.2621891786408647]}, {"timestamp": "08:40", "azimuth": 121.7, "elevation": 16.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.817441578060324, -0.5048622084510079, 0.2773146533023778]}, {"timestamp": "08:45", "azimuth": 122.4, "elevation": 17.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8074348107499804, -0.512413712410845, 0.29237170472273677]}, {"timestamp": "08:50", "azimuth": 123.2, "elevation": 18.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.795810152918386, -0.5207635717861693, 0.3090169943749474]}, {"timestamp": "08:55", "azimuth": 124.0, "elevation": 18.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7843403093122537, -0.5290442187339383, 0.32391741819814934]}, {"timestamp": "09:00", "azimuth": 124.8, "elevation": 19.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7726034993158737, -0.5369734204155374, 0.3387379202452914]}, {"timestamp": "09:05", "azimuth": 125.7, "elevation": 20.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7596586877662062, -0.54587014290631, 0.35347484377925714]}, {"timestamp": "09:10", "azimuth": 126.5, "elevation": 21.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7474072070218383, -0.5530522403919187, 0.368124552684678]}, {"timestamp": "09:15", "azimuth": 127.4, "elevation": 22.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7339434082403933, -0.5611421068622005, 0.3826834323650898]}, {"timestamp": "09:20", "azimuth": 128.2, "elevation": 23.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7217674197904691, -0.5679749529083307, 0.39554550256296495]}, {"timestamp": "09:25", "azimuth": 129.1, "elevation": 24.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7078475389686131, -0.5752520907412666, 0.40992303384157275]}, {"timestamp": "09:30", "azimuth": 130.0, "elevation": 25.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6942720440148838, -0.5825634160695854, 0.42261826174069944]}, {"timestamp": "09:35", "azimuth": 131.0, "elevation": 25.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6789048737413934, -0.5901630029821928, 0.43680178836770217]}, {"timestamp": "09:40", "azimuth": 131.9, "elevation": 26.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6649466394049656, -0.5966224972516966, 0.4493189986158966]}, {"timestamp": "09:45", "azimuth": 132.9, "elevation": 27.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6497734869921826, -0.6038067851370528, 0.4617486132350339]}, {"timestamp": "09:50", "azimuth": 133.9, "elevation": 28.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6344289358803819, -0.6105246066787023, 0.4740882090471163]}, {"timestamp": "09:55", "azimuth": 134.9, "elevation": 29.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6189276746731422, -0.6167709714894466, 0.4863353804234905]}, {"timestamp": "10:00", "azimuth": 135.9, "elevation": 29.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6032845409085605, -0.6225413528560693, 0.49848773975383026]}, {"timestamp": "10:05", "azimuth": 137.0, "elevation": 30.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5870246508535604, -0.6295068675885221, 0.5090414157503713]}, {"timestamp": "10:10", "azimuth": 138.1, "elevation": 31.4, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2]], "sun_direction": [0.5700290101687314, -0.6353077137068331, 0.5210096318405764]}, {"timestamp": "10:15", "azimuth": 139.2, "elevation": 32.1, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2]], "sun_direction": [0.5535269175227748, -0.6412671060204936, 0.5313985795180829]}, {"timestamp": "10:20", "azimuth": 140.3, "elevation": 32.8, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2]], "sun_direction": [0.5369268947914368, -0.6467315707168596, 0.5417082102827397]}, {"timestamp": "10:25", "azimuth": 141.5, "elevation": 33.5, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.519106129521406, -0.6526058462333465, 0.5519369853120581]}, {"timestamp": "10:30", "azimuth": 142.6, "elevation": 34.2, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.5023487583188304, -0.6570449005645416, 0.5620833778521306]}, {"timestamp": "10:35", "azimuth": 143.8, "elevation": 34.8, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.4849753768759849, -0.66263482211917, 0.5707135676844316]}, {"timestamp": "10:40", "azimuth": 145.1, "elevation": 35.5, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.46579283433552543, -0.6676983695578836, 0.5807029557109398]}, {"timestamp": "10:45", "azimuth": 146.3, "elevation": 36.1, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.4483086845151781, -0.6722105145486965, 0.5891963573533421]}, {"timestamp": "10:50", "azimuth": 147.6, "elevation": 36.7, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [0.42961287374735097, -0.6769615664223705, 0.5976251469755212]}, {"timestamp": "10:55", "azimuth": 148.9, "elevation": 37.3, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.4108885650911143, -0.6811377583284967, 0.605988400265711]}, {"timestamp": "11:00", "azimuth": 150.2, "elevation": 37.8, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6]], "sun_direction": [0.392686466326124, -0.6856692225459221, 0.6129070536529764]}, {"timestamp": "11:05", "azimuth": 151.5, "elevation": 38.4, "is_hit": true, "window_id": "window_1d", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6]], "sun_direction": [0.37394619852116423, -0.6887232213791676, 0.6211477802783103]}, {"timestamp": "11:10", "azimuth": 152.9, "elevation": 38.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3545247029004053, -0.6928020159187426, 0.6279630576493378]}, {"timestamp": "11:15", "azimuth": 154.3, "elevation": 39.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.33510293411292297, -0.6962924666825687, 0.6347305132022676]}, {"timestamp": "11:20", "azimuth": 155.7, "elevation": 39.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.31615970143846195, -0.7002161207881624, 0.6401096994849554]}, {"timestamp": "11:25", "azimuth": 157.2, "elevation": 40.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.29554586505047065, -0.7030758300300047, 0.6467897795104595]}, {"timestamp": "11:30", "azimuth": 158.6, "elevation": 40.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.27662561868773516, -0.7058653829219013, 0.6520984038303923]}, {"timestamp": "11:35", "azimuth": 160.1, "elevation": 41.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.25649756852865196, -0.7085667107309246, 0.6573752457940958]}, {"timestamp": "11:40", "azimuth": 161.6, "elevation": 41.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.23677183673221555, -0.7117624000413377, 0.6613118653236518]}, {"timestamp": "11:45", "azimuth": 163.2, "elevation": 41.8, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6]], "sun_direction": [0.2154662677673141, -0.7136587094386132, 0.6665324702494524]}, {"timestamp": "11:50", "azimuth": 164.7, "elevation": 42.1, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6]], "sun_direction": [0.19578742815885866, -0.7156783017294942, 0.6704266189587991]}, {"timestamp": "11:55", "azimuth": 166.3, "elevation": 42.4, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.1748943938260892, -0.7174456363426395, 0.6743023875837234]}, {"timestamp": "12:00", "azimuth": 167.8, "elevation": 42.6, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.15555556710698215, -0.7194729926885254, 0.6768759696826607]}, {"timestamp": "12:05", "azimuth": 169.4, "elevation": 42.8, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.1349705995601924, -0.72120902054659, 0.6794413042615165]}, {"timestamp": "12:10", "azimuth": 171.0, "elevation": 43.0, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.11440892506798764, -0.7223495239403499, 0.6819983600624985]}, {"timestamp": "12:15", "azimuth": 172.6, "elevation": 43.2, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.09388794925506785, -0.7228971660957971, 0.6845471059286887]}, {"timestamp": "12:20", "azimuth": 174.3, "elevation": 43.3, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.07228220816075198, -0.7241743361728491, 0.6858183529273761]}, {"timestamp": "12:25", "azimuth": 175.9, "elevation": 43.4, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.05194823209128702, -0.7247152086710833, 0.687087510804423]}, {"timestamp": "12:30", "azimuth": 177.5, "elevation": 43.5, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.031640385674071986, -0.7246839753408848, 0.6883545756937539]}, {"timestamp": "12:35", "azimuth": 179.2, "elevation": 43.5, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [0.010127807781467733, -0.725303664426848, 0.6883545756937539]}, {"timestamp": "12:40", "azimuth": 180.8, "elevation": 43.5, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.38, 5.28, 0.0], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.010127807781467879, -0.725303664426848, 0.6883545756937539]}, {"timestamp": "12:45", "azimuth": 182.4, "elevation": 43.5, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6]], "sun_direction": [-0.030375525984546497, -0.7247380944469762, 0.6883545756937539]}, {"timestamp": "12:50", "azimuth": 184.1, "elevation": 43.4, "is_hit": true, "window_id": "window_1c", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6]], "sun_direction": [-0.05194823209128684, -0.7247152086710833, 0.687087510804423]}, {"timestamp": "12:55", "azimuth": 185.7, "elevation": 43.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.07228220816075212, -0.7241743361728491, 0.6858183529273761]}, {"timestamp": "13:00", "azimuth": 187.3, "elevation": 43.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.09262611332596529, -0.7230599303617801, 0.6845471059286887]}, {"timestamp": "13:05", "azimuth": 188.9, "elevation": 43.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.11314801369904777, -0.7225481048816215, 0.6819983600624985]}, {"timestamp": "13:10", "azimuth": 190.5, "elevation": 42.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.13349534010605899, -0.7202764002338156, 0.6807208689589177]}, {"timestamp": "13:15", "azimuth": 192.1, "elevation": 42.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.15429961355972807, -0.7197433924125155, 0.6768759696826607]}, {"timestamp": "13:20", "azimuth": 193.7, "elevation": 42.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.174894393826089, -0.7174456363426396, 0.6743023875837234]}, {"timestamp": "13:25", "azimuth": 195.3, "elevation": 42.1, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6]], "sun_direction": [-0.1957874281588585, -0.7156783017294943, 0.6704266189587991]}, {"timestamp": "13:30", "azimuth": 196.8, "elevation": 41.8, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6]], "sun_direction": [-0.2154662677673142, -0.7136587094386131, 0.6665324702494524]}, {"timestamp": "13:35", "azimuth": 198.3, "elevation": 41.5, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.23516644618137675, -0.7110776429427347, 0.6626200482157375]}, {"timestamp": "13:40", "azimuth": 199.8, "elevation": 41.1, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.25526049628124353, -0.7090133040045198, 0.6573752457940958]}, {"timestamp": "13:45", "azimuth": 201.3, "elevation": 40.7, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.275393230487612, -0.7063471103667458, 0.6520984038303923]}, {"timestamp": "13:50", "azimuth": 202.8, "elevation": 40.3, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.2955458650504704, -0.7030758300300048, 0.6467897795104595]}, {"timestamp": "13:55", "azimuth": 204.2, "elevation": 39.9, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.3144786664896582, -0.6997467673970906, 0.6414496315691578]}, {"timestamp": "14:00", "azimuth": 205.6, "elevation": 39.4, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.3338871647290346, -0.6968762708251678, 0.6347305132022676]}, {"timestamp": "14:05", "azimuth": 207.0, "elevation": 38.9, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.0], [7.08, 4.98, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.3533149959182065, -0.6934197227415817, 0.6279630576493378]}, {"timestamp": "14:10", "azimuth": 208.4, "elevation": 38.4, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.0], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.37274358079415215, -0.6893748313015796, 0.6211477802783103]}, {"timestamp": "14:15", "azimuth": 209.8, "elevation": 37.9, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.167867965644035, 4.767867965644037, 0.0], [7.167867965644035, 4.767867965644037, 0.6], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.38, 4.98, 0.6]], "sun_direction": [-0.3921542432240997, -0.6847399086227814, 0.6142852000989432]}, {"timestamp": "14:20", "azimuth": 211.1, "elevation": 37.3, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 5.192132034355964, 0.0], [7.592132034355964, 5.192132034355964, 0.6], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6]], "sun_direction": [-0.41088856509111416, -0.6811377583284968, 0.605988400265711]}, {"timestamp": "14:25", "azimuth": 212.4, "elevation": 36.8, "is_hit": true, "window_id": "window_1b", "hit_points": [[7.68, 4.98, 0.0], [7.68, 4.98, 0.6], [7.592132034355964, 4.767867965644036, 0.0], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2]], "sun_direction": [-0.429053324134598, -0.6760798573175285, 0.5990235985155858]}, {"timestamp": "14:30", "azimuth": 213.7, "elevation": 36.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4477374323646863, -0.671353958083737, 0.5906056676199254]}, {"timestamp": "14:35", "azimuth": 214.9, "elevation": 35.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4657928343355256, -0.6676983695578835, 0.5807029557109398]}, {"timestamp": "14:40", "azimuth": 216.1, "elevation": 34.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.48323049774133675, -0.6626744189660012, 0.5721458734455162]}, {"timestamp": "14:45", "azimuth": 217.3, "elevation": 34.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5012012340954874, -0.6579206633656519, 0.5620833778521306]}, {"timestamp": "14:50", "azimuth": 218.5, "elevation": 33.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5185056635084027, -0.6518509569953568, 0.5533915492433441]}, {"timestamp": "14:55", "azimuth": 219.7, "elevation": 32.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5363221484113887, -0.6460031501813119, 0.5431744499506707]}, {"timestamp": "15:00", "azimuth": 220.8, "elevation": 32.2, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6]], "sun_direction": [-0.5529200497033725, -0.6405640428848713, 0.53287627607073]}, {"timestamp": "15:05", "azimuth": 221.9, "elevation": 31.4, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2]], "sun_direction": [-0.5700290101687313, -0.6353077137068333, 0.5210096318405764]}, {"timestamp": "15:10", "azimuth": 223.0, "elevation": 30.7, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.167867965644036, 5.192132034355964, 0.0], [7.167867965644036, 5.192132034355964, 0.6], [7.167867965644036, 5.192132034355964, 1.2], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.5864178391250816, -0.6288561416780257, 0.5105429179116057]}, {"timestamp": "15:15", "azimuth": 224.1, "elevation": 29.9, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.38, 5.28, 0.0], [7.38, 5.28, 0.6], [7.38, 5.28, 1.2], [7.167867965644036, 5.192132034355964, 0.6], [7.167867965644036, 5.192132034355964, 1.2], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6032845409085608, -0.6225413528560692, 0.49848773975383026]}, {"timestamp": "15:20", "azimuth": 225.1, "elevation": 29.2, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.38, 5.28, 0.6], [7.38, 5.28, 1.2], [7.167867965644036, 5.192132034355964, 0.6], [7.167867965644036, 5.192132034355964, 1.2], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6183254825594554, -0.6161708777625375, 0.4878596591387327]}, {"timestamp": "15:25", "azimuth": 226.1, "elevation": 28.4, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.38, 5.28, 0.6], [7.38, 5.28, 1.2], [7.167867965644036, 5.192132034355964, 0.6], [7.167867965644036, 5.192132034355964, 1.2], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 0.6], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6338317570670566, -0.6099499286659216, 0.4756242090702752]}, {"timestamp": "15:30", "azimuth": 227.1, "elevation": 27.6, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.38, 5.28, 0.6], [7.38, 5.28, 1.2], [7.167867965644036, 5.192132034355964, 0.6], [7.167867965644036, 5.192132034355964, 1.2], [7.08, 4.98, 0.6], [7.08, 4.98, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6491821388457844, -0.6032572705287758, 0.4632960351198617]}, {"timestamp": "15:35", "azimuth": 228.1, "elevation": 26.8, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.167867965644035, 4.767867965644037, 0.6], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 0.6], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6643619306761017, -0.5960978681140986, 0.45087754068943076]}, {"timestamp": "15:40", "azimuth": 229.0, "elevation": 25.9, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.592132034355964, 5.192132034355964, 0.6], [7.592132034355964, 5.192132034355964, 1.2], [7.167867965644035, 4.767867965644037, 1.2], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 1.2], [7.38, 4.98, 1.2], [7.38, 4.98, 0.6]], "sun_direction": [-0.6789048737413933, -0.5901630029821929, 0.43680178836770217]}, {"timestamp": "15:45", "azimuth": 230.0, "elevation": 25.1, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.68, 4.98, 0.6], [7.68, 4.98, 1.2], [7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 1.2]], "sun_direction": [-0.6937059463444101, -0.5820884037230807, 0.4241994227453902]}, {"timestamp": "15:50", "azimuth": 230.9, "elevation": 24.3, "is_hit": true, "window_id": "window_1a", "hit_points": [[7.38, 4.680000000000001, 1.2], [7.592132034355964, 4.767867965644036, 1.2]], "sun_direction": [-0.7072912382216143, -0.5747999973875796, 0.4115143586051088]}, {"timestamp": "15:55", "azimuth": 231.8, "elevation": 23.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7212237988373676, -0.5675471654012032, 0.39714789063478056]}, {"timestamp": "16:00", "azimuth": 232.7, "elevation": 22.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7349216676173469, -0.559860279944748, 0.3826834323650898]}, {"timestamp": "16:05", "azimuth": 233.5, "elevation": 21.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7468895920505683, -0.5526692254613276, 0.3697467572738293]}, {"timestamp": "16:10", "azimuth": 234.4, "elevation": 20.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7601074689239018, -0.5441834993229449, 0.35510696240813705]}, {"timestamp": "16:15", "azimuth": 235.2, "elevation": 19.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.772116851852417, -0.5366351916174287, 0.3403795502130501]}, {"timestamp": "16:20", "azimuth": 236.0, "elevation": 19.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7838704247205585, -0.5287272775749066, 0.3255681544571567]}, {"timestamp": "16:25", "azimuth": 236.8, "elevation": 18.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.7953576436074653, -0.5204674579904888, 0.31067642963073183]}, {"timestamp": "16:30", "azimuth": 237.6, "elevation": 17.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8070027333939905, -0.5121395077827023, 0.294040325232304]}, {"timestamp": "16:35", "azimuth": 238.4, "elevation": 16.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8179079967785503, -0.5031803568867791, 0.2789911060392293]}, {"timestamp": "16:40", "azimuth": 239.1, "elevation": 15.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8276528703340322, -0.4953400243568143, 0.2638730499653729]}, {"timestamp": "16:45", "azimuth": 239.9, "elevation": 14.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8383453365810442, -0.4859717937769702, 0.2469990127227429]}, {"timestamp": "16:50", "azimuth": 240.6, "elevation": 13.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8474957802205976, -0.4775393300392581, 0.2317479034941573]}, {"timestamp": "16:55", "azimuth": 241.3, "elevation": 12.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8566843421384124, -0.46902097735744186, 0.2147353271670632]}, {"timestamp": "17:00", "azimuth": 242.0, "elevation": 11.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8655280739812422, -0.4602094403036206, 0.19765734037912616]}, {"timestamp": "17:05", "azimuth": 242.7, "elevation": 10.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8737372549538789, -0.4509694252987239, 0.18223552549214747]}, {"timestamp": "17:10", "azimuth": 243.4, "elevation": 9.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8818914493481805, -0.4416183412928228, 0.16504760586067765]}, {"timestamp": "17:15", "azimuth": 244.1, "elevation": 8.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8896769133972857, -0.43200389784051274, 0.14780941112961063]}, {"timestamp": "17:20", "azimuth": 244.7, "elevation": 7.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.8963479981189114, -0.423701757622923, 0.13052619222005157]}, {"timestamp": "17:25", "azimuth": 245.4, "elevation": 6.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9033914081140559, -0.4136048792486869, 0.11320321376790672]}, {"timestamp": "17:30", "azimuth": 246.0, "elevation": 5.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9093396755730496, -0.40486410825427954, 0.09584575252022398]}, {"timestamp": "17:35", "azimuth": 246.6, "elevation": 4.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9149254944581191, -0.3959236162293619, 0.07845909572784494]}, {"timestamp": "17:40", "azimuth": 247.3, "elevation": 3.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9208173699559049, -0.3851862497651638, 0.06104853953485687]}, {"timestamp": "17:45", "azimuth": 247.9, "elevation": 2.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9256467809171826, -0.37586618100532826, 0.043619387365336]}, {"timestamp": "17:50", "azimuth": 248.5, "elevation": 1.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.9301398288302152, -0.36639182236291107, 0.024432178152653153]}, {"timestamp": "17:55", "azimuth": 249.1, "elevation": 0.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.934181708416973, -0.3567293058662234, 0.0069812602979615525]}, {"timestamp": "18:00", "azimuth": 249.7, "elevation": -0.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:05", "azimuth": 250.3, "elevation": -1.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:10", "azimuth": 250.9, "elevation": -2.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:15", "azimuth": 251.4, "elevation": -3.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:20", "azimuth": 252.0, "elevation": -4.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}];

        // Active config (mutable, from localStorage or original)
        let config = JSON.parse(JSON.stringify(originalConfig));
        let results = [];  // Will be recalculated

        // Simulation settings
        let simSettings = {
            sampleAngular: 8,
            sampleVertical: 3
        };

        let currentIndex = 0;
        const STORAGE_KEY = 'sunPlantSimulator_config';

        // Room offset - moves room away from origin so sun can be rendered in all directions
        const ROOM_OFFSET_X = 30;
        const ROOM_OFFSET_Y = 30;

        // ========== CONFIG PANEL FUNCTIONS ==========

        function toggleConfig() {
            const body = document.getElementById('configBody');
            const toggle = document.getElementById('configToggle');
            body.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function loadConfigFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge saved config into active config
                    if (parsed.plant) {
                        config.plant = { ...config.plant, ...parsed.plant };
                    }
                    if (parsed.wallThickness !== undefined) {
                        config.windows.forEach(w => w.wall_thickness = parsed.wallThickness);
                    }
                    if (parsed.simulation) {
                        simSettings = { ...simSettings, ...parsed.simulation };
                    }
                    console.log('Loaded config from localStorage:', parsed);
                }
            } catch (e) {
                console.warn('Failed to load config from localStorage:', e);
            }
        }

        function saveConfigToStorage() {
            try {
                const toSave = {
                    plant: {
                        center_x: config.plant.center_x,
                        center_y: config.plant.center_y,
                        radius: config.plant.radius,
                        z_max: config.plant.z_max
                    },
                    wallThickness: config.windows[0]?.wall_thickness || 0,
                    simulation: simSettings
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));

                // Show saved indicator
                const indicator = document.getElementById('savedIndicator');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            } catch (e) {
                console.warn('Failed to save config to localStorage:', e);
            }
        }

        function populateConfigFields() {
            document.getElementById('plantCenterX').value = config.plant.center_x;
            document.getElementById('plantCenterY').value = config.plant.center_y;
            document.getElementById('plantRadius').value = config.plant.radius;
            document.getElementById('plantZMax').value = config.plant.z_max;
            document.getElementById('wallThickness').value = config.windows[0]?.wall_thickness || 0;
            document.getElementById('sampleAngular').value = simSettings.sampleAngular;
            document.getElementById('sampleVertical').value = simSettings.sampleVertical;
        }

        function applyConfig() {
            // Read values from inputs
            config.plant.center_x = parseFloat(document.getElementById('plantCenterX').value);
            config.plant.center_y = parseFloat(document.getElementById('plantCenterY').value);
            config.plant.radius = parseFloat(document.getElementById('plantRadius').value);
            config.plant.z_max = parseFloat(document.getElementById('plantZMax').value);

            const thickness = parseFloat(document.getElementById('wallThickness').value);
            config.windows.forEach(w => w.wall_thickness = thickness);

            simSettings.sampleAngular = parseInt(document.getElementById('sampleAngular').value);
            simSettings.sampleVertical = parseInt(document.getElementById('sampleVertical').value);

            // Save and recalculate
            saveConfigToStorage();
            recalculateAllResults();
            updatePlot(currentIndex);
        }

        function resetConfig() {
            if (confirm('Reset all settings to default values?')) {
                localStorage.removeItem(STORAGE_KEY);
                config = JSON.parse(JSON.stringify(originalConfig));
                simSettings = { sampleAngular: 8, sampleVertical: 3 };
                populateConfigFields();
                recalculateAllResults();
                updatePlot(currentIndex);
            }
        }

        function exportConfig() {
            const exportData = {
                plant: config.plant,
                windows: config.windows.map(w => ({
                    id: w.id,
                    center: w.center,
                    width: w.width,
                    height: w.height,
                    wall_thickness: w.wall_thickness
                })),
                simulation: simSettings
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sun_plant_config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== RAY CASTING (JavaScript implementation) ==========

        function generatePlantSamplePoints() {
            const points = [];
            const plant = config.plant;
            const nAngular = simSettings.sampleAngular;
            const nVertical = simSettings.sampleVertical;

            for (let vi = 0; vi < nVertical; vi++) {
                const z = plant.z_min + (plant.z_max - plant.z_min) * (vi + 0.5) / nVertical;
                for (let ai = 0; ai < nAngular; ai++) {
                    const angle = (2 * Math.PI * ai) / nAngular;
                    const x = plant.center_x + plant.radius * Math.cos(angle);
                    const y = plant.center_y + plant.radius * Math.sin(angle);
                    points.push([x, y, z]);
                }
            }
            return points;
        }

        function sunDirectionFromAngles(azimuthDeg, elevationDeg) {
            const azRad = azimuthDeg * Math.PI / 180;
            const elRad = elevationDeg * Math.PI / 180;
            return [
                Math.sin(azRad) * Math.cos(elRad),
                Math.cos(azRad) * Math.cos(elRad),
                Math.sin(elRad)
            ];
        }

        function rayIntersectsWindowTunnel(origin, direction, window) {
            // Check sun is on correct side of wall
            const azRad = window.wall_normal_azimuth * Math.PI / 180;
            const wallNormal = [Math.sin(azRad), Math.cos(azRad), 0];
            const sunSideCheck = direction[0]*wallNormal[0] + direction[1]*wallNormal[1];
            if (sunSideCheck <= 0) return false;

            // Determine plane axis (wall 1 at y=0, wall 2 at x=0)
            const isWall1 = Math.abs(window.center[1]) < Math.abs(window.center[0]);
            const planeAxis = isWall1 ? 1 : 0;
            const innerCoord = window.center[planeAxis];
            const thickness = window.wall_thickness || 0;
            const outerCoord = innerCoord - thickness;

            // Helper to check intersection with axis-aligned plane
            function checkPlaneIntersection(planeCoord) {
                if (Math.abs(direction[planeAxis]) < 1e-10) return null;
                const t = (planeCoord - origin[planeAxis]) / direction[planeAxis];
                if (t < 0) return null;

                const intersection = [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];

                // Check bounds
                const localH = isWall1
                    ? intersection[0] - window.center[0]
                    : intersection[1] - window.center[1];
                const localV = intersection[2] - window.center[2];

                const withinH = Math.abs(localH) <= window.width / 2 + 1e-6;
                const withinV = Math.abs(localV) <= window.height / 2 + 1e-6;

                return withinH && withinV ? intersection : null;
            }

            // Check inner plane
            const innerHit = checkPlaneIntersection(innerCoord);
            if (!innerHit) return false;

            // If no thickness, single plane is enough
            if (thickness <= 0) return true;

            // Check outer plane for tunnel model
            const outerHit = checkPlaneIntersection(outerCoord);
            return outerHit !== null;
        }

        function checkSunHitsPlant(azimuthDeg, elevationDeg) {
            if (elevationDeg <= 0) {
                return { is_hit: false, reason: 'sun_below_horizon', sun_direction: null, window_id: null, hit_points: [] };
            }

            const sunDir = sunDirectionFromAngles(azimuthDeg, elevationDeg);
            const samplePoints = generatePlantSamplePoints();
            const hitPoints = [];
            let hitWindowId = null;

            for (const pt of samplePoints) {
                for (const window of config.windows) {
                    if (rayIntersectsWindowTunnel(pt, sunDir, window)) {
                        hitPoints.push(pt);
                        if (!hitWindowId) hitWindowId = window.id;
                        break;
                    }
                }
            }

            return {
                is_hit: hitPoints.length > 0,
                window_id: hitWindowId,
                hit_points: hitPoints,
                sun_direction: sunDir,
                reason: hitPoints.length === 0 ? 'no_window_path' : null
            };
        }

        function recalculateAllResults() {
            results = sunPositions.map(sp => {
                const hit = checkSunHitsPlant(sp.azimuth, sp.elevation);
                return {
                    timestamp: sp.timestamp,
                    azimuth: sp.azimuth,
                    elevation: sp.elevation,
                    ...hit
                };
            });
        }

        // Check if sun shines into a window based on wall normal azimuth
        // Sun shines through window if sun direction is opposite to outward normal
        function windowReceivesSun(wallNormalAzimuth, sunDir) {
            if (!sunDir) return false;

            // Convert wall normal azimuth to direction vector
            const azRad = wallNormalAzimuth * Math.PI / 180;
            const outwardNormal = [Math.sin(azRad), Math.cos(azRad), 0];

            // Inward normal is opposite of outward
            const inwardNormal = [-outwardNormal[0], -outwardNormal[1], 0];

            // Sun shines through if sun direction has component INTO the room
            // (dot product of sun direction and inward normal > 0)
            // But sun_direction points TOWARD sun, so light comes FROM opposite direction
            // Light direction = -sunDir, so we check if -sunDir dot inwardNormal > 0
            // Which is equivalent to: sunDir dot inwardNormal < 0
            // Or: sunDir dot outwardNormal > 0 (sun is on the outside)
            const dot = sunDir[0] * outwardNormal[0] + sunDir[1] * outwardNormal[1];
            return dot > 0.1;  // Sun is in direction of outward normal (outside the room)
        }

        function createPlotData(index) {
            const result = results[index];
            const traces = [];
            const sunDir = result.sun_direction;
            const wallThickness = config.windows[0]?.wall_thickness || 0;
            const wallHeight = 6;
            const wallLength = 15;

            // Get wall info
            const wall1 = config.walls?.find(w => w.id === 'wall_1') || { normal_azimuth: 210, thickness: 0.3 };
            const wall2 = config.walls?.find(w => w.id === 'wall_2') || { normal_azimuth: 300, thickness: 0.3 };

            // ========== COMPASS (ENU: X=East, Y=North) ==========
            const compassCenter = [ROOM_OFFSET_X - 3, ROOM_OFFSET_Y - 3, 0.1];
            const compassLen = 2;
            // North arrow (Y+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0]],
                y: [compassCenter[1], compassCenter[1] + compassLen],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'red', width: 5 },
                text: ['', 'N'],
                textposition: 'top center',
                textfont: { size: 16, color: 'red' },
                name: 'North',
                showlegend: false,
            });
            // East arrow (X+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0] + compassLen],
                y: [compassCenter[1], compassCenter[1]],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'blue', width: 5 },
                text: ['', 'E'],
                textposition: 'middle right',
                textfont: { size: 16, color: 'blue' },
                name: 'East',
                showlegend: false,
            });

            // ========== WALL GEOMETRY (rotated to actual azimuths) ==========
            // Wall normal azimuths from config
            const wall1Az = wall1.normal_azimuth * Math.PI / 180;  // 210° = SW
            const wall2Az = wall2.normal_azimuth * Math.PI / 180;  // 300° = NW

            // Outward normal directions (pointing outside the room)
            const wall1Normal = [Math.sin(wall1Az), Math.cos(wall1Az)];  // Points outward at 210°
            const wall2Normal = [Math.sin(wall2Az), Math.cos(wall2Az)];  // Points outward at 300°

            // Wall directions: perpendicular to normal
            // Wall 1: 210° - 90° = 120° (toward ESE)
            // Wall 2: 300° + 90° = 30° (toward NNE)
            const wall1Dir = [-Math.cos(wall1Az), Math.sin(wall1Az)];   // 120° (ESE)
            const wall2Dir = [Math.cos(wall2Az), -Math.sin(wall2Az)];   // 30° (NNE)

            // Position the plant at the room offset, then calculate corner from plant's ENU position
            // Plant ENU coords (center_x, center_y) represent offset FROM corner in ENU space
            // So corner = plant_viz_position - plant_ENU_position
            const plant = config.plant;
            const plantVizX = ROOM_OFFSET_X;
            const plantVizY = ROOM_OFFSET_Y;
            const cornerX = plantVizX - plant.center_x;
            const cornerY = plantVizY - plant.center_y;

            // ========== WALL 1 (normal at azimuth ${wall1.normal_azimuth}°) ==========
            // Wall runs from corner along wall1Dir
            const w1InnerStart = [cornerX, cornerY];
            const w1InnerEnd = [cornerX + wallLength * wall1Dir[0], cornerY + wallLength * wall1Dir[1]];
            const w1OuterStart = [cornerX - wallThickness * wall1Normal[0], cornerY - wallThickness * wall1Normal[1]];
            const w1OuterEnd = [w1InnerEnd[0] - wallThickness * wall1Normal[0], w1InnerEnd[1] - wallThickness * wall1Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 1 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w1OuterStart[0], w1OuterEnd[0], w1OuterEnd[0], w1OuterStart[0]],
                    y: [w1OuterStart[1], w1OuterEnd[1], w1OuterEnd[1], w1OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 1 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 1 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#2E7D32', width: 4 },
                name: `Wall 1 (azimuth ${wall1.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== WALL 2 (normal at azimuth ${wall2.normal_azimuth}°) ==========
            // Wall runs from corner along wall2Dir
            const w2InnerStart = [cornerX, cornerY];
            const w2InnerEnd = [cornerX + wallLength * wall2Dir[0], cornerY + wallLength * wall2Dir[1]];
            const w2OuterStart = [cornerX - wallThickness * wall2Normal[0], cornerY - wallThickness * wall2Normal[1]];
            const w2OuterEnd = [w2InnerEnd[0] - wallThickness * wall2Normal[0], w2InnerEnd[1] - wallThickness * wall2Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 2 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w2OuterStart[0], w2OuterEnd[0], w2OuterEnd[0], w2OuterStart[0]],
                    y: [w2OuterStart[1], w2OuterEnd[1], w2OuterEnd[1], w2OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 2 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 2 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#1565C0', width: 4 },
                name: `Wall 2 (azimuth ${wall2.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== FLOOR (triangular, bounded by rotated walls) ==========
            // Floor is the area between the two walls and extending inward
            const floorCorners = [
                [cornerX, cornerY],  // Corner
                [w1InnerEnd[0], w1InnerEnd[1]],  // End of wall 1
                [cornerX + wallLength * wall1Dir[0] + wallLength * wall2Dir[0],
                 cornerY + wallLength * wall1Dir[1] + wallLength * wall2Dir[1]],  // Far corner
                [w2InnerEnd[0], w2InnerEnd[1]],  // End of wall 2
            ];
            traces.push({
                type: 'mesh3d',
                x: floorCorners.map(c => c[0]),
                y: floorCorners.map(c => c[1]),
                z: [0, 0, 0, 0],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(200, 180, 160, 0.3)',
                name: 'Floor',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Add windows with sun exposure coloring (positioned on rotated walls)
            config.windows.forEach((w, i) => {
                const isWall1 = w.wall_id === 'wall_1' || w.id.startsWith('window_1');
                const receivesSun = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                const thickness = w.wall_thickness || 0;

                // Colors: bright yellow/orange if receiving sun, otherwise default
                let color, frameColor, outerColor;
                if (receivesSun) {
                    color = 'rgba(255, 200, 50, 0.8)';  // Bright yellow - sun hitting
                    outerColor = 'rgba(255, 220, 100, 0.6)';
                    frameColor = '#FF8C00';  // Dark orange frame
                } else {
                    color = isWall1 ? 'rgba(144, 238, 144, 0.5)' : 'rgba(135, 206, 235, 0.5)';
                    outerColor = isWall1 ? 'rgba(144, 238, 144, 0.3)' : 'rgba(135, 206, 235, 0.3)';
                    frameColor = isWall1 ? '#228B22' : '#4169E1';
                }

                // Window position along wall (from config x_position or y_position)
                const wallPos = isWall1 ? (w.center[0] || 0) : (w.center[1] || 0);
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallNormal = isWall1 ? wall1Normal : wall2Normal;

                // Window center on wall (in world coordinates)
                const windowCenterX = cornerX + wallPos * wallDir[0];
                const windowCenterY = cornerY + wallPos * wallDir[1];

                // Window corners (perpendicular to wall = along wallDir, vertical = Z)
                const halfW = w.width / 2;
                const halfH = w.height / 2;
                const wz = w.center[2];

                let innerCorners = [
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz + halfH],
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz + halfH],
                ];

                // Outer corners (offset by wall thickness in outward normal direction)
                let outerCorners = innerCorners.map(c => [
                    c[0] - thickness * wallNormal[0],
                    c[1] - thickness * wallNormal[1],
                    c[2]
                ]);

                // Inner window mesh
                traces.push({
                    type: 'mesh3d',
                    x: innerCorners.map(c => c[0]),
                    y: innerCorners.map(c => c[1]),
                    z: innerCorners.map(c => c[2]),
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: color,
                    name: w.id + ' (inner)',
                    showlegend: false,
                    hoverinfo: 'name',
                });

                // Inner window frame
                const innerFrameX = [...innerCorners.map(c => c[0]), innerCorners[0][0]];
                const innerFrameY = [...innerCorners.map(c => c[1]), innerCorners[0][1]];
                const innerFrameZ = [...innerCorners.map(c => c[2]), innerCorners[0][2]];
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: innerFrameX,
                    y: innerFrameY,
                    z: innerFrameZ,
                    line: { color: frameColor, width: 3 },
                    name: w.id,
                    showlegend: i === 0,
                });

                // Outer window (only if wall has thickness)
                if (thickness > 0) {
                    // Outer window mesh
                    traces.push({
                        type: 'mesh3d',
                        x: outerCorners.map(c => c[0]),
                        y: outerCorners.map(c => c[1]),
                        z: outerCorners.map(c => c[2]),
                        i: [0, 0],
                        j: [1, 2],
                        k: [2, 3],
                        color: outerColor,
                        name: w.id + ' (outer)',
                        showlegend: false,
                        hoverinfo: 'name',
                    });

                    // Outer window frame
                    const outerFrameX = [...outerCorners.map(c => c[0]), outerCorners[0][0]];
                    const outerFrameY = [...outerCorners.map(c => c[1]), outerCorners[0][1]];
                    const outerFrameZ = [...outerCorners.map(c => c[2]), outerCorners[0][2]];
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: outerFrameX,
                        y: outerFrameY,
                        z: outerFrameZ,
                        line: { color: frameColor, width: 2, dash: 'dot' },
                        name: w.id + ' outer frame',
                        showlegend: false,
                    });

                    // Tunnel edges (connect inner to outer corners)
                    for (let ci = 0; ci < 4; ci++) {
                        traces.push({
                            type: 'scatter3d',
                            mode: 'lines',
                            x: [innerCorners[ci][0], outerCorners[ci][0]],
                            y: [innerCorners[ci][1], outerCorners[ci][1]],
                            z: [innerCorners[ci][2], outerCorners[ci][2]],
                            line: { color: frameColor, width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip',
                        });
                    }
                }
            });

            // Add plant cylinder
            // Plant is positioned at the room offset center (plantVizX, plantVizY)
            // This was calculated earlier: corner + plant.center = plantViz position
            const plantX = plantVizX;
            const plantY = plantVizY;
            const nPts = 20;
            const theta = Array.from({length: nPts}, (_, i) => 2 * Math.PI * i / nPts);

            // Bottom circle
            const xBottom = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yBottom = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zBottom = theta.map(() => plant.z_min);

            // Top circle
            const xTop = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yTop = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zTop = theta.map(() => plant.z_max);

            // Combine for mesh
            const allX = [...xBottom, ...xTop];
            const allY = [...yBottom, ...yTop];
            const allZ = [...zBottom, ...zTop];

            const iIdx = [], jIdx = [], kIdx = [];
            for (let idx = 0; idx < nPts; idx++) {
                const next = (idx + 1) % nPts;
                iIdx.push(idx, next);
                jIdx.push(next, next + nPts);
                kIdx.push(idx + nPts, idx + nPts);
            }

            traces.push({
                type: 'mesh3d',
                x: allX,
                y: allY,
                z: allZ,
                i: iIdx,
                j: jIdx,
                k: kIdx,
                color: 'rgba(34, 139, 34, 0.8)',
                name: 'Plant',
                showlegend: true,
            });

            // Helper function to find ray-window intersection (with rotated walls)
            function rayWindowIntersection(origin, direction, window) {
                // Get actual wall normal from config azimuth
                const azRad = window.wall_normal_azimuth * Math.PI / 180;
                const normal = [Math.sin(azRad), Math.cos(azRad), 0];

                const isWall1 = window.id.startsWith('window_1');
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallPos = isWall1 ? (window.center[0] || 0) : (window.center[1] || 0);

                // Window center on wall (in world coordinates)
                const windowCenter = [
                    cornerX + wallPos * wallDir[0],
                    cornerY + wallPos * wallDir[1],
                    window.center[2]
                ];

                const denom = direction[0]*normal[0] + direction[1]*normal[1] + direction[2]*normal[2];
                if (Math.abs(denom) < 1e-10) return null;

                const diff = [
                    windowCenter[0] - origin[0],
                    windowCenter[1] - origin[1],
                    windowCenter[2] - origin[2]
                ];
                const t = (diff[0]*normal[0] + diff[1]*normal[1] + diff[2]*normal[2]) / denom;
                if (t < 0) return null;

                return [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];
            }

            // Draw sun rays from far away through windows that receive sunlight
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];

                // Draw rays through each window that receives sun
                config.windows.forEach((w, wIdx) => {
                    const receivesSunRay = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                    if (!receivesSunRay) return;

                    const isWall1 = w.id.startsWith('window_1');
                    const wallDir = isWall1 ? wall1Dir : wall2Dir;
                    const wallPos = isWall1 ? (w.center[0] || 0) : (w.center[1] || 0);

                    // Window center on rotated wall (in world coordinates)
                    const windowCenter = [
                        cornerX + wallPos * wallDir[0],
                        cornerY + wallPos * wallDir[1],
                        w.center[2]
                    ];

                    // Calculate sun position along the ray direction from window
                    const sunStart = [
                        windowCenter[0] + sunDist * sunDir[0],
                        windowCenter[1] + sunDist * sunDir[1],
                        windowCenter[2] + sunDist * sunDir[2]
                    ];

                    // Draw ray from far away (sun) through window into room
                    // Ray continues 10m past window into room (negative sun direction)
                    const roomEnd = [
                        windowCenter[0] - 10 * sunDir[0],
                        windowCenter[1] - 10 * sunDir[1],
                        windowCenter[2] - 10 * sunDir[2]
                    ];

                    // Only draw up to floor level (z >= 0)
                    if (roomEnd[2] < 0) {
                        const t = windowCenter[2] / (windowCenter[2] - roomEnd[2]);
                        roomEnd[0] = windowCenter[0] + t * (roomEnd[0] - windowCenter[0]);
                        roomEnd[1] = windowCenter[1] + t * (roomEnd[1] - windowCenter[1]);
                        roomEnd[2] = 0;
                    }

                    // Draw the incoming ray from sun to window (bright yellow)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [sunStart[0], windowCenter[0]],
                        y: [sunStart[1], windowCenter[1]],
                        z: [sunStart[2], windowCenter[2]],
                        line: { color: 'rgba(255, 215, 0, 0.6)', width: 3 },
                        name: wIdx === 0 ? 'Sun ray (incoming)' : '',
                        showlegend: wIdx === 0,
                    });

                    // Draw ray passing through window into room (brighter)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [windowCenter[0], roomEnd[0]],
                        y: [windowCenter[1], roomEnd[1]],
                        z: [windowCenter[2], roomEnd[2]],
                        line: { color: '#FFD700', width: 4 },
                        name: wIdx === 0 ? 'Sunlight in room' : '',
                        showlegend: wIdx === 0,
                    });

                    // Mark where light enters window
                    traces.push({
                        type: 'scatter3d',
                        mode: 'markers',
                        x: [windowCenter[0]],
                        y: [windowCenter[1]],
                        z: [windowCenter[2]],
                        marker: { size: 6, color: '#FF6600', symbol: 'circle' },
                        name: '',
                        showlegend: false,
                    });
                });

                // Also draw rays to plant hit points if plant is hit
                if (result.is_hit && result.hit_points) {
                    const hitWindow = config.windows.find(w => w.id === result.window_id);

                    result.hit_points.forEach((pt, i) => {
                        if (i < 3) { // Limit rays shown
                            // Convert hit point from ENU to visualization coordinates
                            const ptOffset = [pt[0] + cornerX, pt[1] + cornerY, pt[2]];

                            // Find window intersection for this ray
                            let windowPt = null;
                            if (hitWindow) {
                                windowPt = rayWindowIntersection(ptOffset, sunDir, hitWindow);
                            }

                            if (windowPt) {
                                // Draw ray from window to plant (showing light hitting plant)
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'lines',
                                    x: [windowPt[0], ptOffset[0]],
                                    y: [windowPt[1], ptOffset[1]],
                                    z: [windowPt[2], ptOffset[2]],
                                    line: { color: '#FF4500', width: 5 },
                                    name: i === 0 ? 'Ray hitting plant' : '',
                                    showlegend: i === 0,
                                });

                                // Mark hit point on plant
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'markers',
                                    x: [ptOffset[0]],
                                    y: [ptOffset[1]],
                                    z: [ptOffset[2]],
                                    marker: { size: 8, color: '#FF0000', symbol: 'diamond' },
                                    name: i === 0 ? 'Plant hit' : '',
                                    showlegend: i === 0,
                                });
                            }
                        }
                    });
                }
            }

            // Add sun indicator - far away so rays appear parallel (from "infinity")
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                // Sun very far away - rays will appear nearly parallel
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];
                const sunPos = [
                    roomCenter[0] + sunDist * sunDir[0],
                    roomCenter[1] + sunDist * sunDir[1],
                    Math.max(5, sunDist * sunDir[2]),
                ];

                // Sun marker (larger since it's further away)
                traces.push({
                    type: 'scatter3d',
                    mode: 'markers',
                    x: [sunPos[0]],
                    y: [sunPos[1]],
                    z: [sunPos[2]],
                    marker: { size: 25, color: '#FFD700', symbol: 'circle',
                              line: { color: '#FFA500', width: 3 } },
                    name: `Sun (El: ${result.elevation.toFixed(0)}°)`,
                    showlegend: true,
                });

                // Draw line from room center toward sun to show direction
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: [roomCenter[0], sunPos[0]],
                    y: [roomCenter[1], sunPos[1]],
                    z: [roomCenter[2], sunPos[2]],
                    line: { color: 'rgba(255, 215, 0, 0.4)', width: 3, dash: 'dot' },
                    name: 'Sun direction',
                    showlegend: false,
                });
            }

            return traces;
        }

        function updatePlot(index) {
            const result = results[index];
            const traces = createPlotData(index);

            // Update info displays
            document.getElementById('currentTime').textContent = result.timestamp;
            document.getElementById('sunInfo').textContent =
                `Sun: Az ${result.azimuth.toFixed(0)}°, El ${result.elevation.toFixed(0)}°`;

            const statusEl = document.getElementById('statusDisplay');
            if (result.is_hit) {
                statusEl.textContent = '☀️ SUNLIGHT HITTING PLANT';
                statusEl.className = 'status hit';
                document.getElementById('windowInfo').textContent = `Through: ${result.window_id}`;
                const totalSamples = simSettings.sampleAngular * simSettings.sampleVertical;
                const hitCount = result.hit_points ? result.hit_points.length : 0;
                document.getElementById('hitPointsInfo').textContent = `Hits: ${hitCount}/${totalSamples} (${Math.round(100*hitCount/totalSamples)}%)`;
            } else {
                statusEl.textContent = 'No direct sunlight';
                statusEl.className = 'status miss';
                document.getElementById('windowInfo').textContent = '';
                document.getElementById('hitPointsInfo').textContent = '';
            }

            Plotly.react('plot3d', traces, {
                scene: {
                    xaxis: { title: 'X (meters)', range: [-30, 120] },
                    yaxis: { title: 'Y (meters)', range: [-30, 120] },
                    zaxis: { title: 'Z (meters)', range: [0, 80] },
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 1.2, y: 1.2, z: 0.7 }
                    }
                },
                title: `Sun-Plant Simulation - ${result.timestamp}`,
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved config from localStorage
            loadConfigFromStorage();

            // Populate form fields with current config
            populateConfigFields();

            // Calculate initial results with current config
            recalculateAllResults();

            const slider = document.getElementById('timeSlider');

            slider.addEventListener('input', function() {
                currentIndex = parseInt(this.value);
                updatePlot(currentIndex);
            });

            // Auto-apply on Enter key in inputs
            document.querySelectorAll('.config-field input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyConfig();
                });
            });

            // Initial plot
            updatePlot(0);
        });
    </script>
</body>
</html>