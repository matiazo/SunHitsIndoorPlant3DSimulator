<!DOCTYPE html>
<html>
<head>
    <title>Sun-Plant Simulation</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        h1 {
            color: #333;
            margin-bottom: 10px;
        }
        .controls {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .time-display {
            font-size: 32px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .status {
            font-size: 24px;
            padding: 10px 20px;
            border-radius: 4px;
            display: inline-block;
            margin-bottom: 15px;
        }
        .status.hit {
            background: #4CAF50;
            color: white;
        }
        .status.miss {
            background: #9E9E9E;
            color: white;
        }
        .info {
            color: #666;
            font-size: 14px;
        }
        .slider-container {
            margin: 20px 0;
        }
        #timeSlider {
            width: 100%;
            height: 30px;
            cursor: pointer;
        }
        .plot-container {
            background: white;
            border-radius: 8px;
            padding: 10px;
        }
        /* Config panel styles */
        .config-panel {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .config-header {
            background: #f0f0f0;
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 8px 8px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: #333;
        }
        .config-header:hover {
            background: #e8e8e8;
        }
        .config-toggle {
            font-size: 18px;
            transition: transform 0.3s;
        }
        .config-toggle.open {
            transform: rotate(180deg);
        }
        .config-body {
            padding: 20px;
            display: none;
            border-top: 1px solid #ddd;
        }
        .config-body.open {
            display: block;
        }
        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .config-group {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
        }
        .config-group h4 {
            margin: 0 0 12px 0;
            color: #555;
            font-size: 14px;
            text-transform: uppercase;
        }
        .config-field {
            margin-bottom: 12px;
        }
        .config-field:last-child {
            margin-bottom: 0;
        }
        .config-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
        }
        .config-field input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }
        .config-field input:focus {
            outline: none;
            border-color: #4CAF50;
        }
        .config-field .value-display {
            font-size: 11px;
            color: #888;
            margin-top: 2px;
        }
        .config-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .config-actions button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-apply {
            background: #4CAF50;
            color: white;
        }
        .btn-apply:hover {
            background: #45a049;
        }
        .btn-reset {
            background: #f44336;
            color: white;
        }
        .btn-reset:hover {
            background: #da190b;
        }
        .btn-export {
            background: #2196F3;
            color: white;
        }
        .btn-export:hover {
            background: #1976D2;
        }
        .saved-indicator {
            color: #4CAF50;
            font-size: 12px;
            margin-left: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .saved-indicator.show {
            opacity: 1;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .legend {
            margin-top: 15px;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 4px;
        }
        .legend-item {
            display: inline-block;
            margin-right: 20px;
        }
        .legend-color {
            display: inline-block;
            width: 20px;
            height: 20px;
            vertical-align: middle;
            margin-right: 5px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sun Hits Indoor Plant - 3D Simulation</h1>
        <h2 style="color: #666; margin-top: 0;">Date: 2026-02-02</h2>

        <!-- Configuration Panel -->
        <div class="config-panel">
            <div class="config-header" onclick="toggleConfig()">
                <span>⚙️ Configuration <span class="saved-indicator" id="savedIndicator">✓ Saved</span></span>
                <span class="config-toggle" id="configToggle">▼</span>
            </div>
            <div class="config-body" id="configBody">
                <div class="config-grid">
                    <div class="config-group">
                        <h4>Plant Position</h4>
                        <div class="config-field">
                            <label>Center X (meters)</label>
                            <input type="number" id="plantCenterX" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 1</div>
                        </div>
                        <div class="config-field">
                            <label>Center Y (meters)</label>
                            <input type="number" id="plantCenterY" step="0.5" min="0" max="20">
                            <div class="value-display">Distance along Wall 2</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Plant Size</h4>
                        <div class="config-field">
                            <label>Radius (meters)</label>
                            <input type="number" id="plantRadius" step="0.05" min="0.1" max="2">
                        </div>
                        <div class="config-field">
                            <label>Height (z_max, meters)</label>
                            <input type="number" id="plantZMax" step="0.1" min="0.1" max="5">
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Wall Properties</h4>
                        <div class="config-field">
                            <label>Wall Thickness (meters)</label>
                            <input type="number" id="wallThickness" step="0.05" min="0" max="1">
                            <div class="value-display">0 = thin plane model</div>
                        </div>
                    </div>
                    <div class="config-group">
                        <h4>Simulation</h4>
                        <div class="config-field">
                            <label>Angular Samples</label>
                            <input type="number" id="sampleAngular" step="1" min="4" max="16">
                        </div>
                        <div class="config-field">
                            <label>Vertical Samples</label>
                            <input type="number" id="sampleVertical" step="1" min="2" max="10">
                        </div>
                    </div>
                </div>
                <div class="config-actions">
                    <button class="btn-apply" onclick="applyConfig()">Apply Changes</button>
                    <button class="btn-reset" onclick="resetConfig()">Reset to Default</button>
                    <button class="btn-export" onclick="exportConfig()">Export JSON</button>
                </div>
            </div>
        </div>

        <div class="controls">
            <div class="time-display">Time: <span id="currentTime">--:--</span></div>
            <div id="statusDisplay" class="status miss">Loading...</div>
            <div class="info">
                <span id="sunInfo">Sun: Az --°, El --°</span>
                <span id="windowInfo" style="margin-left: 20px;"></span>
                <span id="hitPointsInfo" style="margin-left: 20px;"></span>
            </div>

            <div class="slider-container">
                <input type="range" id="timeSlider" min="0" max="137" value="0">
            </div>

            <div class="legend">
                <span class="legend-item"><span class="legend-color" style="background: #90EE90;"></span> Wall 1 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #87CEEB;"></span> Wall 2 windows</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFC832;"></span> Window receiving sun</span>
                <span class="legend-item"><span class="legend-color" style="background: #228B22;"></span> Plant</span>
                <span class="legend-item"><span class="legend-color" style="background: #FFD700;"></span> Sun rays through window</span>
                <span class="legend-item"><span class="legend-color" style="background: #FF4500;"></span> Ray hitting plant</span>
            </div>
        </div>

        <div class="plot-container">
            <div id="plot3d" style="width: 100%; height: 700px;"></div>
        </div>
    </div>

    <script>
        // Original config from file (immutable)
        const originalConfig = {"plant": {"center_x": 3.9, "center_y": 8.0, "radius": 0.3, "z_min": 0.0, "z_max": 1.2}, "walls": [{"id": "wall_1", "normal_azimuth": 210.0, "thickness": 0.3, "draw_length": 6.5}, {"id": "wall_2", "normal_azimuth": 300.0, "thickness": 0.3, "draw_length": 10.0}], "windows": [{"id": "window_1a", "wall_id": "wall_1", "center": [0.8049999999999999, 0.0, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 210.0, "wall_thickness": 0.3, "axis": "x", "position_along_wall": 0.36, "x_position": 0.36}, {"id": "window_1b", "wall_id": "wall_1", "center": [1.885, 0.0, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 210.0, "wall_thickness": 0.3, "axis": "x", "position_along_wall": 1.44, "x_position": 1.44}, {"id": "window_1c", "wall_id": "wall_1", "center": [2.965, 0.0, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 210.0, "wall_thickness": 0.3, "axis": "x", "position_along_wall": 2.52, "x_position": 2.52}, {"id": "window_1d", "wall_id": "wall_1", "center": [4.045, 0.0, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 210.0, "wall_thickness": 0.3, "axis": "x", "position_along_wall": 3.6, "x_position": 3.6}, {"id": "window_2a", "wall_id": "wall_2", "center": [0.0, 1.245, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 300.0, "wall_thickness": 0.3, "axis": "y", "position_along_wall": 0.8, "y_position": 0.8}, {"id": "window_2b", "wall_id": "wall_2", "center": [0.0, 4.445, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 300.0, "wall_thickness": 0.3, "axis": "y", "position_along_wall": 4.0, "y_position": 4.0}, {"id": "window_2c", "wall_id": "wall_2", "center": [0.0, 5.515000000000001, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 300.0, "wall_thickness": 0.3, "axis": "y", "position_along_wall": 5.07, "y_position": 5.07}, {"id": "window_2d", "wall_id": "wall_2", "center": [0.0, 8.705, 4.95], "width": 0.89, "height": 1.5, "wall_normal_azimuth": 300.0, "wall_thickness": 0.3, "axis": "y", "position_along_wall": 8.26, "y_position": 8.26}]};
        const sunPositions = [{"timestamp": "06:55", "azimuth": 107.0, "elevation": -4.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:00", "azimuth": 107.6, "elevation": -3.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:05", "azimuth": 108.2, "elevation": -2.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:10", "azimuth": 108.8, "elevation": -1.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:15", "azimuth": 109.4, "elevation": -0.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "07:20", "azimuth": 109.9, "elevation": 0.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.984429706167829, 0.1753536384136734, 0.012217000835247169]}, {"timestamp": "07:25", "azimuth": 110.5, "elevation": 1.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9857989291307248, 0.16496616483040483, 0.03141075907812829]}, {"timestamp": "07:30", "azimuth": 111.2, "elevation": 2.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9870485724838087, 0.15280319220680913, 0.04884976979561326]}, {"timestamp": "07:35", "azimuth": 111.8, "elevation": 3.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9876001764803629, 0.14231535947228902, 0.06627390040000014]}, {"timestamp": "07:40", "azimuth": 112.4, "elevation": 4.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.987739207837801, 0.13179254848133826, 0.08367784333231548]}, {"timestamp": "07:45", "azimuth": 113.0, "elevation": 5.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9874650188902043, 0.12124545875141214, 0.10105629718294634]}, {"timestamp": "07:50", "azimuth": 113.7, "elevation": 6.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9869689451716115, 0.10896238596924043, 0.11840396830650095]}, {"timestamp": "07:55", "azimuth": 114.3, "elevation": 7.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9856119584945836, 0.09837715200753512, 0.13744454603714665]}, {"timestamp": "08:00", "azimuth": 115.0, "elevation": 8.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.984200380206898, 0.08610637590600774, 0.1547103862994681]}, {"timestamp": "08:05", "azimuth": 115.6, "elevation": 9.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9822059648870242, 0.07557663010125963, 0.17192910027940955]}, {"timestamp": "08:10", "azimuth": 116.3, "elevation": 10.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9802397891317983, 0.06338926365697439, 0.18738131458572463]}, {"timestamp": "08:15", "azimuth": 117.0, "elevation": 11.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9775258850255061, 0.051229960825876365, 0.20449605184179034]}, {"timestamp": "08:20", "azimuth": 117.7, "elevation": 12.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9743637692215898, 0.03913449157525045, 0.2215484976194673]}, {"timestamp": "08:25", "azimuth": 118.4, "elevation": 13.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.970755649260103, 0.027115660515709957, 0.23853345757858088]}, {"timestamp": "08:30", "azimuth": 119.2, "elevation": 14.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9671734673934069, 0.013505166800496654, 0.2537579445848056]}, {"timestamp": "08:35", "azimuth": 119.9, "elevation": 15.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9626902801634718, 0.00168021321265427, 0.27060044597586363]}, {"timestamp": "08:40", "azimuth": 120.7, "elevation": 16.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9582510545260043, -0.011707827692676812, 0.28568836740497355]}, {"timestamp": "08:45", "azimuth": 121.4, "elevation": 17.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9529061306381299, -0.023288524208963685, 0.3023698907504445]}, {"timestamp": "08:50", "azimuth": 122.2, "elevation": 18.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9476246614025271, -0.03640406742923465, 0.31730465640509214]}, {"timestamp": "08:55", "azimuth": 123.0, "elevation": 19.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9419300040761853, -0.04936445975369883, 0.3321611318837033]}, {"timestamp": "09:00", "azimuth": 123.8, "elevation": 20.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9352213453187032, -0.062117333218299625, 0.3485720473218152]}, {"timestamp": "09:05", "azimuth": 124.6, "elevation": 21.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9286901369002475, -0.07472063425899496, 0.36325123047297836]}, {"timestamp": "09:10", "azimuth": 125.5, "elevation": 22.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9216080602998654, -0.08874076293745378, 0.3778407868184671]}, {"timestamp": "09:15", "azimuth": 126.4, "elevation": 23.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9140890953926073, -0.10253152012687765, 0.39233711660356146]}, {"timestamp": "09:20", "azimuth": 127.2, "elevation": 24.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.9063418788462868, -0.11449760621432942, 0.4067366430758002]}, {"timestamp": "09:25", "azimuth": 128.1, "elevation": 24.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8987211796898642, -0.12790696505047916, 0.4194520824461771]}, {"timestamp": "09:30", "azimuth": 129.0, "elevation": 25.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8899832679380262, -0.14095950179056604, 0.4336590845875443]}, {"timestamp": "09:35", "azimuth": 130.0, "elevation": 26.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8813382977427052, -0.1554037210237093, 0.44619781310980877]}, {"timestamp": "09:40", "azimuth": 130.9, "elevation": 27.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.871798052700638, -0.16788184354560884, 0.46019978478385165]}, {"timestamp": "09:45", "azimuth": 131.9, "elevation": 28.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8623633464468095, -0.18172846042029947, 0.47255076486905395]}, {"timestamp": "09:50", "azimuth": 132.9, "elevation": 29.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.852545350194374, -0.19525895108433453, 0.48480962024633706]}, {"timestamp": "09:55", "azimuth": 133.9, "elevation": 29.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8423542277293897, -0.20846159619221308, 0.49697396102755537]}, {"timestamp": "10:00", "azimuth": 135.0, "elevation": 30.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8314129536555118, -0.22277642950876891, 0.5090414157503713]}, {"timestamp": "10:05", "azimuth": 136.0, "elevation": 31.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.8204856869583855, -0.23527048481646265, 0.5210096318405764]}, {"timestamp": "10:10", "azimuth": 137.1, "elevation": 32.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.809673215139587, -0.2490880052746177, 0.5313985795180829]}, {"timestamp": "10:15", "azimuth": 138.2, "elevation": 32.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7976154052126073, -0.26224260197060745, 0.5431744499506707]}, {"timestamp": "10:20", "azimuth": 139.4, "elevation": 33.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7856301865235935, -0.2766640620842451, 0.5533915492433441]}, {"timestamp": "10:25", "azimuth": 140.5, "elevation": 34.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7737832980397147, -0.2893057203782737, 0.5635260489375714]}, {"timestamp": "10:30", "azimuth": 141.7, "elevation": 35.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7611008453876101, -0.30287881209008266, 0.573576436351046]}, {"timestamp": "10:35", "azimuth": 142.9, "elevation": 35.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7480794930730696, -0.31600114982793015, 0.5835412113561176]}, {"timestamp": "10:40", "azimuth": 144.2, "elevation": 36.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7351033984310367, -0.3303685665180388, 0.5920131787992196]}, {"timestamp": "10:45", "azimuth": 145.4, "elevation": 36.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.7223833751727247, -0.34301284566860923, 0.600420225325884]}, {"timestamp": "10:50", "azimuth": 146.7, "elevation": 37.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.707808898641994, -0.3559907891661, 0.6101451639012676]}, {"timestamp": "10:55", "azimuth": 148.0, "elevation": 38.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6938704521608159, -0.3689374637651208, 0.6184083953575542]}, {"timestamp": "11:00", "azimuth": 149.4, "elevation": 38.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6799217494913081, -0.3831162163977794, 0.6252426563357052]}, {"timestamp": "11:05", "azimuth": 150.7, "elevation": 39.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6653882621863374, -0.3950786386710994, 0.6333808726275502]}, {"timestamp": "11:10", "azimuth": 152.1, "elevation": 39.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6508298146727841, -0.4082647731047457, 0.6401096994849554]}, {"timestamp": "11:15", "azimuth": 153.5, "elevation": 40.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6359783070728832, -0.420944858685221, 0.6467897795104595]}, {"timestamp": "11:20", "azimuth": 155.0, "elevation": 40.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6200940473537953, -0.4341945263560963, 0.6534206039901054]}, {"timestamp": "11:25", "azimuth": 156.4, "elevation": 41.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.6056140932082837, -0.44649721750092614, 0.6586894601186805]}, {"timestamp": "11:30", "azimuth": 157.9, "elevation": 41.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5891603067713049, -0.4586487852066929, 0.6652303546543609]}, {"timestamp": "11:35", "azimuth": 159.4, "elevation": 42.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5733496430457902, -0.4709547063261373, 0.6704266189587991]}, {"timestamp": "11:40", "azimuth": 161.0, "elevation": 42.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.557319320137025, -0.48447029372387157, 0.6743023875837234]}, {"timestamp": "11:45", "azimuth": 162.5, "elevation": 42.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.540962400438734, -0.4957007114933086, 0.6794413042615165]}, {"timestamp": "11:50", "azimuth": 164.1, "elevation": 43.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5243487324760022, -0.5081292718893587, 0.6832737736807991]}, {"timestamp": "11:55", "azimuth": 165.7, "elevation": 43.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.5074508562131336, -0.5200042125071099, 0.687087510804423]}, {"timestamp": "12:00", "azimuth": 167.3, "elevation": 43.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4902871609954939, -0.5313191073428523, 0.6908824110768584]}, {"timestamp": "12:05", "azimuth": 168.9, "elevation": 43.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4736724641480661, -0.5429809400445461, 0.6934018282758129]}, {"timestamp": "12:10", "azimuth": 170.6, "elevation": 44.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.45581667352327326, -0.5549203002929717, 0.6959127965923143]}, {"timestamp": "12:15", "azimuth": 172.2, "elevation": 44.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.43939956826762266, -0.5664705100603308, 0.6971651028545646]}, {"timestamp": "12:20", "azimuth": 173.9, "elevation": 44.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.4209647002681291, -0.5772866974648235, 0.6996633405133653]}, {"timestamp": "12:25", "azimuth": 175.5, "elevation": 44.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.40398950289036684, -0.5878083741943766, 0.7009092642998509]}, {"timestamp": "12:30", "azimuth": 177.2, "elevation": 44.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.38571035504847856, -0.5985053150791138, 0.7021530529951624]}, {"timestamp": "12:35", "azimuth": 178.9, "elevation": 44.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.36778518377548214, -0.6096844665602098, 0.7021530529951624]}, {"timestamp": "12:40", "azimuth": 180.6, "elevation": 44.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.34953625864872717, -0.6203269251446553, 0.7021530529951624]}, {"timestamp": "12:45", "azimuth": 182.2, "elevation": 44.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.3320794354242378, -0.6298446941412559, 0.7021530529951624]}, {"timestamp": "12:50", "azimuth": 183.9, "elevation": 44.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.31378681050024915, -0.6405185717641001, 0.7009092642998509]}, {"timestamp": "12:55", "azimuth": 185.6, "elevation": 44.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.29515182894492187, -0.6506585954340003, 0.6996633405133653]}, {"timestamp": "13:00", "azimuth": 187.2, "elevation": 44.3, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.2773420894207121, -0.6597707590611153, 0.6984152854310058]}, {"timestamp": "13:05", "azimuth": 188.9, "elevation": 44.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.25808553046158006, -0.6688442855614073, 0.6971651028545646]}, {"timestamp": "13:10", "azimuth": 190.5, "elevation": 44.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.2401205594728932, -0.678079541993176, 0.6946583704589973]}, {"timestamp": "13:15", "azimuth": 192.2, "elevation": 43.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.22063871303876978, -0.6872091276847211, 0.6921431738704068]}, {"timestamp": "13:20", "azimuth": 193.8, "elevation": 43.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.2023729980612283, -0.6965724282349841, 0.6883545756937539]}, {"timestamp": "13:25", "azimuth": 195.4, "elevation": 43.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.1837506540934785, -0.7054296257493553, 0.6845471059286887]}, {"timestamp": "13:30", "azimuth": 197.0, "elevation": 42.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.1647862974343322, -0.7137678717494224, 0.6807208689589177]}, {"timestamp": "13:35", "azimuth": 198.5, "elevation": 42.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.14675415578957712, -0.7213197206680587, 0.6768759696826607]}, {"timestamp": "13:40", "azimuth": 200.1, "elevation": 42.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.1273658677224322, -0.7297735166603997, 0.6717205893229902]}, {"timestamp": "13:45", "azimuth": 201.6, "elevation": 41.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.10890139175426415, -0.737478781374181, 0.6665324702494524]}, {"timestamp": "13:50", "azimuth": 203.1, "elevation": 41.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.0901159726802794, -0.7446782716381883, 0.6613118653236518]}, {"timestamp": "13:55", "azimuth": 204.6, "elevation": 41.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.07102444564008907, -0.7513601523913487, 0.6560590289905073]}, {"timestamp": "14:00", "azimuth": 206.0, "elevation": 40.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.05304323877425497, -0.7585536548856994, 0.6494480483301837]}, {"timestamp": "14:05", "azimuth": 207.4, "elevation": 40.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.034750064979686995, -0.7652558538275762, 0.6427876096865393]}, {"timestamp": "14:10", "azimuth": 208.8, "elevation": 39.5, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [0.016159686017625793, -0.7714553533653676, 0.636078220277764]}, {"timestamp": "14:15", "azimuth": 210.2, "elevation": 39.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.0027127456501949195, -0.7771412268178269, 0.6293203910498374]}, {"timestamp": "14:20", "azimuth": 211.6, "elevation": 38.4, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.02188200558547668, -0.7833879070338557, 0.6211477802783103]}, {"timestamp": "14:25", "azimuth": 212.9, "elevation": 37.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.03997626519243785, -0.7891431060357122, 0.6129070536529764]}, {"timestamp": "14:30", "azimuth": 214.2, "elevation": 37.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.058336415154312204, -0.7943908187879417, 0.6045991148623748]}, {"timestamp": "14:35", "azimuth": 215.5, "elevation": 36.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.07694664504607872, -0.7991214627879722, 0.5962248749656158]}, {"timestamp": "14:40", "azimuth": 216.7, "elevation": 35.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.09450815527196378, -0.804509582194772, 0.5863723567357892]}, {"timestamp": "14:45", "azimuth": 217.9, "elevation": 35.2, "is_hit": true, "window_id": "window_1c", "hit_points": [[3.9, 7.7, 0.0]], "sun_direction": [-0.11231210959824224, -0.8093897546378506, 0.5764323161697933]}, {"timestamp": "14:50", "azimuth": 219.1, "elevation": 34.6, "is_hit": true, "window_id": "window_1c", "hit_points": [[3.9, 7.7, 0.0], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.1301856571342814, -0.8127762151297144, 0.5678437450531013]}, {"timestamp": "14:55", "azimuth": 220.3, "elevation": 33.9, "is_hit": true, "window_id": "window_1c", "hit_points": [[4.2, 8.0, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.148408035148835, -0.8166366686063612, 0.5577451089796901]}, {"timestamp": "15:00", "azimuth": 221.4, "elevation": 33.2, "is_hit": true, "window_id": "window_1c", "hit_points": [[4.2, 8.0, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0]], "sun_direction": [-0.16539260872246372, -0.820255936435955, 0.5475632234925503]}, {"timestamp": "15:05", "azimuth": 222.6, "elevation": 32.4, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0]], "sun_direction": [-0.18418443047062805, -0.8239937750703865, 0.5358267949789967]}, {"timestamp": "15:10", "azimuth": 223.7, "elevation": 31.7, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.2, 8.0, 0.0], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6, 8.0, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0]], "sun_direction": [-0.20150452580802425, -0.8266047846451581, 0.5254716510722678]}, {"timestamp": "15:15", "azimuth": 224.7, "elevation": 30.9, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.2, 8.0, 0.0], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6]], "sun_direction": [-0.217740786796787, -0.8299785130951544, 0.51354125205817]}, {"timestamp": "15:20", "azimuth": 225.8, "elevation": 30.1, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [3.9, 8.3, 0.0], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6], [3.9, 8.0, 0.6]], "sun_direction": [-0.235563642520223, -0.832464263999592, 0.5015107371594574]}, {"timestamp": "15:25", "azimuth": 226.8, "elevation": 29.3, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.9, 7.7, 0.0], [3.9, 7.7, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6]], "sun_direction": [-0.252055748871114, -0.8348489176978731, 0.48938245174884626]}, {"timestamp": "15:30", "azimuth": 227.8, "elevation": 28.5, "is_hit": true, "window_id": "window_1b", "hit_points": [[4.2, 8.0, 0.0], [4.2, 8.0, 0.6], [3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [4.112132034355964, 7.787867965644035, 0.0], [4.112132034355964, 7.787867965644035, 0.6]], "sun_direction": [-0.2686502652619956, -0.8367476038102368, 0.4771587602596084]}, {"timestamp": "15:35", "azimuth": 228.8, "elevation": 27.7, "is_hit": true, "window_id": "window_1a", "hit_points": [[3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.6878679656440356, 7.787867965644036, 0.0], [3.6878679656440356, 7.787867965644036, 0.6], [3.6878679656440356, 7.787867965644036, 1.2], [3.9, 8.0, 0.6]], "sun_direction": [-0.28533199235641005, -0.8381572207315714, 0.4648420457246196]}, {"timestamp": "15:40", "azimuth": 229.8, "elevation": 26.9, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6, 8.0, 0.0], [3.6, 8.0, 0.6], [3.6, 8.0, 1.2], [3.6878679656440356, 7.787867965644036, 0.6], [3.6878679656440356, 7.787867965644036, 1.2], [3.9, 7.7, 0.6], [3.9, 7.7, 1.2], [3.9, 8.0, 1.2], [3.9, 8.0, 0.6]], "sun_direction": [-0.30208564045835895, -0.8390751454064325, 0.4524347093117827]}, {"timestamp": "15:45", "azimuth": 230.7, "elevation": 26.0, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.6], [4.2, 8.0, 1.2], [4.112132034355964, 8.212132034355964, 0.0], [4.112132034355964, 8.212132034355964, 0.6], [4.112132034355964, 8.212132034355964, 1.2], [3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.9, 8.3, 1.2], [3.6878679656440356, 8.212132034355964, 0.0], [3.6878679656440356, 8.212132034355964, 0.6], [3.6878679656440356, 8.212132034355964, 1.2], [3.6, 8.0, 0.6], [3.6, 8.0, 1.2], [3.6878679656440356, 7.787867965644036, 0.6], [3.6878679656440356, 7.787867965644036, 1.2], [3.9, 7.7, 0.6], [3.9, 7.7, 1.2], [4.112132034355964, 7.787867965644035, 0.6], [4.112132034355964, 7.787867965644035, 1.2], [3.9, 8.0, 1.2], [3.9, 8.0, 0.6]], "sun_direction": [-0.31770108510532413, -0.8407715255559793, 0.4383711467890774]}, {"timestamp": "15:50", "azimuth": 231.6, "elevation": 25.2, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.6], [4.2, 8.0, 1.2], [4.112132034355964, 8.212132034355964, 0.6], [4.112132034355964, 8.212132034355964, 1.2], [3.9, 8.3, 0.0], [3.9, 8.3, 0.6], [3.9, 8.3, 1.2], [3.6878679656440356, 7.787867965644036, 0.6], [3.6878679656440356, 7.787867965644036, 1.2], [3.9, 7.7, 0.6], [3.9, 7.7, 1.2], [4.112132034355964, 7.787867965644035, 0.6], [4.112132034355964, 7.787867965644035, 1.2], [3.9, 8.0, 1.2], [3.9, 8.0, 0.6]], "sun_direction": [-0.33308905394604904, -0.8412869171784803, 0.42577929156507266]}, {"timestamp": "15:55", "azimuth": 232.5, "elevation": 24.3, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.6], [4.2, 8.0, 1.2], [4.112132034355964, 8.212132034355964, 0.6], [4.112132034355964, 8.212132034355964, 1.2], [3.9, 7.7, 0.6], [3.9, 7.7, 1.2], [4.112132034355964, 7.787867965644035, 0.6], [4.112132034355964, 7.787867965644035, 1.2], [3.9, 8.0, 1.2], [3.9, 8.0, 0.6]], "sun_direction": [-0.3487789341716415, -0.8420268331472103, 0.4115143586051088]}, {"timestamp": "16:00", "azimuth": 233.4, "elevation": 23.4, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.6], [4.2, 8.0, 1.2], [4.112132034355964, 8.212132034355964, 0.6], [4.112132034355964, 8.212132034355964, 1.2], [3.9, 7.7, 0.6], [3.9, 7.7, 1.2], [4.112132034355964, 7.787867965644035, 0.6], [4.112132034355964, 7.787867965644035, 1.2]], "sun_direction": [-0.36448431371070594, -0.8422735529643443, 0.39714789063478056]}, {"timestamp": "16:05", "azimuth": 234.3, "elevation": 22.5, "is_hit": true, "window_id": "window_1a", "hit_points": [[4.2, 8.0, 0.6], [4.2, 8.0, 1.2], [4.112132034355964, 7.787867965644035, 1.2]], "sun_direction": [-0.38018969324977, -0.84202683314721, 0.3826834323650898]}, {"timestamp": "16:10", "azimuth": 235.2, "elevation": 21.6, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.39587957347536207, -0.8412869171784803, 0.368124552684678]}, {"timestamp": "16:15", "azimuth": 236.0, "elevation": 20.7, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.41007167255188604, -0.840771525555979, 0.35347484377925714]}, {"timestamp": "16:20", "azimuth": 236.8, "elevation": 19.8, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.42422200718806174, -0.8398168312228725, 0.3387379202452914]}, {"timestamp": "16:25", "azimuth": 237.6, "elevation": 18.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4383175956297531, -0.8384242312512189, 0.32391741819814934]}, {"timestamp": "16:30", "azimuth": 238.4, "elevation": 17.9, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.4526013357008579, -0.8370686593204064, 0.30735661779980705]}, {"timestamp": "16:35", "azimuth": 239.2, "elevation": 17.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.46654251227687515, -0.8347795340782515, 0.29237170472273677]}, {"timestamp": "16:40", "azimuth": 239.9, "elevation": 16.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.47893662895861583, -0.8328963251843167, 0.2773146533023778]}, {"timestamp": "16:45", "azimuth": 240.7, "elevation": 15.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.49291521413287404, -0.8301638348261114, 0.26050450864264835]}, {"timestamp": "16:50", "azimuth": 241.4, "elevation": 14.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5053126616159838, -0.8278350319013241, 0.2436150117860225]}, {"timestamp": "16:55", "azimuth": 242.1, "elevation": 13.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5173584460355707, -0.8247400308190248, 0.22835087011065572]}, {"timestamp": "17:00", "azimuth": 242.8, "elevation": 12.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5294742147956248, -0.8215831584627603, 0.21132479645538865]}, {"timestamp": "17:05", "azimuth": 243.5, "elevation": 11.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5414254311697545, -0.8180045961293873, 0.19423435121997196]}, {"timestamp": "17:10", "azimuth": 244.2, "elevation": 10.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5531999917945825, -0.8140090686377023, 0.1770847403195833]}, {"timestamp": "17:15", "azimuth": 244.9, "elevation": 9.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5647859405899295, -0.8096016595426401, 0.15988118769183485]}, {"timestamp": "17:20", "azimuth": 245.6, "elevation": 8.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5761714793271291, -0.8047878066173819, 0.14262893370551163]}, {"timestamp": "17:25", "azimuth": 246.2, "elevation": 7.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5859485655253798, -0.8005971890551861, 0.12533323356430426]}, {"timestamp": "17:30", "azimuth": 246.9, "elevation": 6.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.5969083457962027, -0.7950072741088127, 0.10799935570602284]}, {"timestamp": "17:35", "azimuth": 247.5, "elevation": 5.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6062560096289484, -0.790088214185908, 0.09063258019778016]}, {"timestamp": "17:40", "azimuth": 248.1, "elevation": 4.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6153788112447316, -0.7848216900369888, 0.07323819712763169]}, {"timestamp": "17:45", "azimuth": 248.7, "elevation": 3.2, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6242677555909929, -0.7792135322937369, 0.0558215049931638]}, {"timestamp": "17:50", "azimuth": 249.4, "elevation": 2.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6343042242407243, -0.7722146008219489, 0.036643708706556276]}, {"timestamp": "17:55", "azimuth": 250.0, "elevation": 1.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6426691517217167, -0.7659032704138293, 0.01919744239968967]}, {"timestamp": "18:00", "azimuth": 250.6, "elevation": 0.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": [-0.6507732260802876, -0.7592701508988418, 0.0017453283658983088]}, {"timestamp": "18:05", "azimuth": 251.2, "elevation": -1.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:10", "azimuth": 251.7, "elevation": -2.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:15", "azimuth": 252.3, "elevation": -3.0, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}, {"timestamp": "18:20", "azimuth": 252.9, "elevation": -4.1, "is_hit": false, "window_id": null, "hit_points": [], "sun_direction": null}];

        function ensureWallDrawLengths(target) {
            if (!target.walls) {
                target.walls = [];
            }
            target.walls.forEach(wall => {
                if (typeof wall.draw_length !== 'number') {
                    const fallback = wall.visualization?.wall_length ?? wall.visualization?.draw_length;
                    wall.draw_length = typeof fallback === 'number' ? fallback : 15;
                }
            });
        }

        ensureWallDrawLengths(originalConfig);

        // Active config (mutable, from localStorage or original)
        let config = JSON.parse(JSON.stringify(originalConfig));
        ensureWallDrawLengths(config);
        let results = [];  // Will be recalculated

        // Simulation settings
        let simSettings = {
            sampleAngular: 8,
            sampleVertical: 3
        };

        let currentIndex = 0;
        const STORAGE_KEY = 'sunPlantSimulator_config';

        // Room offset - moves room away from origin so sun can be rendered in all directions
        const ROOM_OFFSET_X = 30;
        const ROOM_OFFSET_Y = 30;

        function getWindowAxis(window) {
            if (window.axis === 'x' || window.axis === 'y') {
                return window.axis;
            }
            if (window.wall_id === 'wall_1') {
                return 'x';
            }
            if (window.wall_id === 'wall_2') {
                return 'y';
            }
            return (window.id || '').startsWith('window_1') ? 'x' : 'y';
        }

        function getWindowPositionAlongWall(window) {
            if (typeof window.position_along_wall === 'number') {
                return window.position_along_wall;
            }
            if (typeof window.x_position === 'number') {
                return window.x_position;
            }
            if (typeof window.y_position === 'number') {
                return window.y_position;
            }
            const axis = getWindowAxis(window);
            if (window.center) {
                if (axis === 'x') {
                    return (window.center[0] || 0) - (window.width || 0) / 2;
                }
                return (window.center[1] || 0) - (window.width || 0) / 2;
            }
            return 0;
        }

        function getWindowCenterAlongWall(window) {
            return getWindowPositionAlongWall(window) + (window.width || 0) / 2;
        }

        // ========== CONFIG PANEL FUNCTIONS ==========

        function toggleConfig() {
            const body = document.getElementById('configBody');
            const toggle = document.getElementById('configToggle');
            body.classList.toggle('open');
            toggle.classList.toggle('open');
        }

        function loadConfigFromStorage() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge saved config into active config
                    if (parsed.plant) {
                        config.plant = { ...config.plant, ...parsed.plant };
                    }
                    if (parsed.wallThickness !== undefined) {
                        config.windows.forEach(w => w.wall_thickness = parsed.wallThickness);
                    }
                    if (parsed.simulation) {
                        simSettings = { ...simSettings, ...parsed.simulation };
                    }
                    if (Array.isArray(parsed.wallDrawLengths)) {
                        parsed.wallDrawLengths.forEach(saved => {
                            const targetWall = config.walls?.find(w => w.id === saved.id);
                            if (targetWall && typeof saved.draw_length === 'number') {
                                targetWall.draw_length = saved.draw_length;
                            }
                        });
                    }
                    ensureWallDrawLengths(config);
                    console.log('Loaded config from localStorage:', parsed);
                }
            } catch (e) {
                console.warn('Failed to load config from localStorage:', e);
            }
        }

        function saveConfigToStorage() {
            try {
                const toSave = {
                    plant: {
                        center_x: config.plant.center_x,
                        center_y: config.plant.center_y,
                        radius: config.plant.radius,
                        z_max: config.plant.z_max
                    },
                    wallThickness: config.windows[0]?.wall_thickness || 0,
                    simulation: simSettings,
                    wallDrawLengths: config.walls?.map(w => {
                        return { id: w.id, draw_length: w.draw_length };
                    }) || [],
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));

                // Show saved indicator
                const indicator = document.getElementById('savedIndicator');
                indicator.classList.add('show');
                setTimeout(() => indicator.classList.remove('show'), 2000);
            } catch (e) {
                console.warn('Failed to save config to localStorage:', e);
            }
        }

        function populateConfigFields() {
            document.getElementById('plantCenterX').value = config.plant.center_x;
            document.getElementById('plantCenterY').value = config.plant.center_y;
            document.getElementById('plantRadius').value = config.plant.radius;
            document.getElementById('plantZMax').value = config.plant.z_max;
            document.getElementById('wallThickness').value = config.windows[0]?.wall_thickness || 0;
            document.getElementById('sampleAngular').value = simSettings.sampleAngular;
            document.getElementById('sampleVertical').value = simSettings.sampleVertical;
        }

        function applyConfig() {
            // Read values from inputs
            config.plant.center_x = parseFloat(document.getElementById('plantCenterX').value);
            config.plant.center_y = parseFloat(document.getElementById('plantCenterY').value);
            config.plant.radius = parseFloat(document.getElementById('plantRadius').value);
            config.plant.z_max = parseFloat(document.getElementById('plantZMax').value);

            const thickness = parseFloat(document.getElementById('wallThickness').value);
            config.windows.forEach(w => w.wall_thickness = thickness);

            simSettings.sampleAngular = parseInt(document.getElementById('sampleAngular').value);
            simSettings.sampleVertical = parseInt(document.getElementById('sampleVertical').value);

            // Save and recalculate
            saveConfigToStorage();
            recalculateAllResults();
            updatePlot(currentIndex);
        }

        function resetConfig() {
            if (confirm('Reset all settings to default values?')) {
                localStorage.removeItem(STORAGE_KEY);
                config = JSON.parse(JSON.stringify(originalConfig));
                ensureWallDrawLengths(config);
                simSettings = { sampleAngular: 8, sampleVertical: 3 };
                populateConfigFields();
                recalculateAllResults();
                updatePlot(currentIndex);
            }
        }

        function exportConfig() {
            const exportData = {
                plant: config.plant,
                windows: config.windows.map(w => {
                    const axis = getWindowAxis(w);
                    const position = getWindowPositionAlongWall(w);
                    const base = {
                        id: w.id,
                        wall_id: w.wall_id,
                        axis,
                        center: w.center,
                        width: w.width,
                        height: w.height,
                        wall_thickness: w.wall_thickness,
                        position_along_wall: position,
                    };

                    if (axis === 'x') {
                        base.x_position = position;
                    } else if (axis === 'y') {
                        base.y_position = position;
                    }

                    return base;
                }),
                simulation: simSettings,
                walls: config.walls,
            };
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'sun_plant_config.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        // ========== RAY CASTING (JavaScript implementation) ==========

        function generatePlantSamplePoints() {
            const points = [];
            const plant = config.plant;
            const nAngular = simSettings.sampleAngular;
            const nVertical = simSettings.sampleVertical;

            for (let vi = 0; vi < nVertical; vi++) {
                const z = plant.z_min + (plant.z_max - plant.z_min) * (vi + 0.5) / nVertical;
                for (let ai = 0; ai < nAngular; ai++) {
                    const angle = (2 * Math.PI * ai) / nAngular;
                    const x = plant.center_x + plant.radius * Math.cos(angle);
                    const y = plant.center_y + plant.radius * Math.sin(angle);
                    points.push([x, y, z]);
                }
            }
            return points;
        }

        function sunDirectionFromAngles(azimuthDeg, elevationDeg) {
            // In the simplified coordinate system, wall 1 is at y=0 along X-axis.
            // The real-world wall 1 has outward normal at wall1_normal_azimuth.
            // We need to rotate the sun azimuth from ENU (real-world) into simplified coords.
            // The rotation angle is: wall1_normal_azimuth - 180° (inward normal direction).
            const wall1NormalAz = config.walls?.find(w => w.id === 'wall_1')?.normal_azimuth || 210;
            const rotation = wall1NormalAz - 180;  // 210 - 180 = 30° for default config
            const rotatedAzimuth = azimuthDeg - rotation;

            const azRad = rotatedAzimuth * Math.PI / 180;
            const elRad = elevationDeg * Math.PI / 180;
            return [
                Math.sin(azRad) * Math.cos(elRad),
                Math.cos(azRad) * Math.cos(elRad),
                Math.sin(elRad)
            ];
        }

        function rayIntersectsWindowTunnel(origin, direction, window) {
            // Check sun is on correct side of wall
            const azRad = window.wall_normal_azimuth * Math.PI / 180;
            const wallNormal = [Math.sin(azRad), Math.cos(azRad), 0];
            const sunSideCheck = direction[0]*wallNormal[0] + direction[1]*wallNormal[1];
            if (sunSideCheck <= 0) return false;

            // Determine plane axis (wall 1 at y=0, wall 2 at x=0)
            const axis = getWindowAxis(window);
            const isWall1 = axis === 'x';
            const planeAxis = isWall1 ? 1 : 0;
            const innerCoord = window.center ? window.center[planeAxis] : 0;
            const thickness = window.wall_thickness || 0;
            const outerCoord = innerCoord - thickness;
            const centerAlongWall = getWindowCenterAlongWall(window);

            // Helper to check intersection with axis-aligned plane
            function checkPlaneIntersection(planeCoord) {
                if (Math.abs(direction[planeAxis]) < 1e-10) return null;
                const t = (planeCoord - origin[planeAxis]) / direction[planeAxis];
                if (t < 0) return null;

                const intersection = [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];

                // Check bounds
                const localH = isWall1
                    ? intersection[0] - centerAlongWall
                    : intersection[1] - centerAlongWall;
                const localV = intersection[2] - window.center[2];

                const withinH = Math.abs(localH) <= window.width / 2 + 1e-6;
                const withinV = Math.abs(localV) <= window.height / 2 + 1e-6;

                return withinH && withinV ? intersection : null;
            }

            // Check inner plane
            const innerHit = checkPlaneIntersection(innerCoord);
            if (!innerHit) return false;

            // If no thickness, single plane is enough
            if (thickness <= 0) return true;

            // Check outer plane for tunnel model
            const outerHit = checkPlaneIntersection(outerCoord);
            return outerHit !== null;
        }

        function checkSunHitsPlant(azimuthDeg, elevationDeg) {
            if (elevationDeg <= 0) {
                return { is_hit: false, reason: 'sun_below_horizon', sun_direction: null, window_id: null, hit_points: [] };
            }

            const sunDir = sunDirectionFromAngles(azimuthDeg, elevationDeg);
            const samplePoints = generatePlantSamplePoints();
            const hitPoints = [];
            let hitWindowId = null;

            for (const pt of samplePoints) {
                for (const window of config.windows) {
                    if (rayIntersectsWindowTunnel(pt, sunDir, window)) {
                        hitPoints.push(pt);
                        if (!hitWindowId) hitWindowId = window.id;
                        break;
                    }
                }
            }

            return {
                is_hit: hitPoints.length > 0,
                window_id: hitWindowId,
                hit_points: hitPoints,
                sun_direction: sunDir,
                reason: hitPoints.length === 0 ? 'no_window_path' : null
            };
        }

        function recalculateAllResults() {
            results = sunPositions.map(sp => {
                const hit = checkSunHitsPlant(sp.azimuth, sp.elevation);
                return {
                    timestamp: sp.timestamp,
                    azimuth: sp.azimuth,
                    elevation: sp.elevation,
                    ...hit
                };
            });
        }

        // Check if sun shines into a window based on wall normal azimuth
        // Sun shines through window if sun direction is opposite to outward normal
        function windowReceivesSun(wallNormalAzimuth, sunDir) {
            if (!sunDir) return false;

            // Convert wall normal azimuth to direction vector
            const azRad = wallNormalAzimuth * Math.PI / 180;
            const outwardNormal = [Math.sin(azRad), Math.cos(azRad), 0];

            // Inward normal is opposite of outward
            const inwardNormal = [-outwardNormal[0], -outwardNormal[1], 0];

            // Sun shines through if sun direction has component INTO the room
            // (dot product of sun direction and inward normal > 0)
            // But sun_direction points TOWARD sun, so light comes FROM opposite direction
            // Light direction = -sunDir, so we check if -sunDir dot inwardNormal > 0
            // Which is equivalent to: sunDir dot inwardNormal < 0
            // Or: sunDir dot outwardNormal > 0 (sun is on the outside)
            const dot = sunDir[0] * outwardNormal[0] + sunDir[1] * outwardNormal[1];
            return dot > 0.1;  // Sun is in direction of outward normal (outside the room)
        }

        function createPlotData(index) {
            const result = results[index];
            const traces = [];
            const sunDir = result.sun_direction;
            const wallThickness = config.windows[0]?.wall_thickness || 0;
            const wallHeight = 6;

            // Get wall info
            const wall1 = config.walls?.find(w => w.id === 'wall_1') || { normal_azimuth: 210, thickness: 0.3, draw_length: 15 };
            const wall2 = config.walls?.find(w => w.id === 'wall_2') || { normal_azimuth: 300, thickness: 0.3, draw_length: 15 };
            const wall1Length = typeof wall1.draw_length === 'number' ? wall1.draw_length : 15;
            const wall2Length = typeof wall2.draw_length === 'number' ? wall2.draw_length : 15;

            // ========== COMPASS (ENU: X=East, Y=North) ==========
            const compassCenter = [ROOM_OFFSET_X - 3, ROOM_OFFSET_Y - 3, 0.1];
            const compassLen = 2;
            // North arrow (Y+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0]],
                y: [compassCenter[1], compassCenter[1] + compassLen],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'red', width: 5 },
                text: ['', 'N'],
                textposition: 'top center',
                textfont: { size: 16, color: 'red' },
                name: 'North',
                showlegend: false,
            });
            // East arrow (X+ direction)
            traces.push({
                type: 'scatter3d',
                mode: 'lines+text',
                x: [compassCenter[0], compassCenter[0] + compassLen],
                y: [compassCenter[1], compassCenter[1]],
                z: [compassCenter[2], compassCenter[2]],
                line: { color: 'blue', width: 5 },
                text: ['', 'E'],
                textposition: 'middle right',
                textfont: { size: 16, color: 'blue' },
                name: 'East',
                showlegend: false,
            });

            // ========== WALL GEOMETRY (simplified axis-aligned) ==========
            // In the simplified coordinate system:
            // - Wall 1 runs along the X axis at y=0 (normal points -Y, azimuth 180° in simplified)
            // - Wall 2 runs along the Y axis at x=0 (normal points -X, azimuth 270° in simplified)
            // The actual wall azimuths (210°, 300°) define the real-world orientation
            // but the coordinates use simplified axis-aligned geometry

            // Simplified wall normals (axis-aligned)
            const wall1Normal = [0, -1];  // Wall 1 at y=0, normal points -Y
            const wall2Normal = [-1, 0];  // Wall 2 at x=0, normal points -X

            // Wall directions (perpendicular to normal, along the wall)
            const wall1Dir = [1, 0];   // Wall 1 runs along +X
            const wall2Dir = [0, 1];   // Wall 2 runs along +Y

            // Corner is at origin in simplified coords, offset for visualization
            const plant = config.plant;
            const plantVizX = ROOM_OFFSET_X;
            const plantVizY = ROOM_OFFSET_Y;
            // In simplified coords, plant.center_x is distance from wall_2 (x=0)
            // and plant.center_y is distance from wall_1 (y=0)
            // So corner in viz coords = plant viz position - plant simplified coords
            const cornerX = plantVizX - plant.center_x;
            const cornerY = plantVizY - plant.center_y;

            // ========== WALL 1 (at y=0, runs along X) ==========
            // Wall runs from corner along wall1Dir
            const w1InnerStart = [cornerX, cornerY];
            const w1InnerEnd = [cornerX + wall1Length * wall1Dir[0], cornerY + wall1Length * wall1Dir[1]];
            const w1OuterStart = [cornerX - wallThickness * wall1Normal[0], cornerY - wallThickness * wall1Normal[1]];
            const w1OuterEnd = [w1InnerEnd[0] - wallThickness * wall1Normal[0], w1InnerEnd[1] - wallThickness * wall1Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 1 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w1OuterStart[0], w1OuterEnd[0], w1OuterEnd[0], w1OuterStart[0]],
                    y: [w1OuterStart[1], w1OuterEnd[1], w1OuterEnd[1], w1OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 1 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 1 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w1InnerStart[0], w1InnerEnd[0], w1InnerEnd[0], w1InnerStart[0], w1InnerStart[0]],
                y: [w1InnerStart[1], w1InnerEnd[1], w1InnerEnd[1], w1InnerStart[1], w1InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#2E7D32', width: 4 },
                name: `Wall 1 (azimuth ${wall1.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== WALL 2 (normal at azimuth ${wall2.normal_azimuth}°) ==========
            // Wall runs from corner along wall2Dir
            const w2InnerStart = [cornerX, cornerY];
            const w2InnerEnd = [cornerX + wall2Length * wall2Dir[0], cornerY + wall2Length * wall2Dir[1]];
            const w2OuterStart = [cornerX - wallThickness * wall2Normal[0], cornerY - wallThickness * wall2Normal[1]];
            const w2OuterEnd = [w2InnerEnd[0] - wallThickness * wall2Normal[0], w2InnerEnd[1] - wallThickness * wall2Normal[1]];

            // Inner surface
            traces.push({
                type: 'mesh3d',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(180, 180, 180, 0.3)',
                name: 'Wall 2 Inner',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Outer surface
            if (wallThickness > 0) {
                traces.push({
                    type: 'mesh3d',
                    x: [w2OuterStart[0], w2OuterEnd[0], w2OuterEnd[0], w2OuterStart[0]],
                    y: [w2OuterStart[1], w2OuterEnd[1], w2OuterEnd[1], w2OuterStart[1]],
                    z: [0, 0, wallHeight, wallHeight],
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: 'rgba(150, 150, 150, 0.2)',
                    name: 'Wall 2 Outer',
                    showlegend: false,
                    hoverinfo: 'name',
                });
            }

            // Wall 2 frame
            traces.push({
                type: 'scatter3d',
                mode: 'lines',
                x: [w2InnerStart[0], w2InnerEnd[0], w2InnerEnd[0], w2InnerStart[0], w2InnerStart[0]],
                y: [w2InnerStart[1], w2InnerEnd[1], w2InnerEnd[1], w2InnerStart[1], w2InnerStart[1]],
                z: [0, 0, wallHeight, wallHeight, 0],
                line: { color: '#1565C0', width: 4 },
                name: `Wall 2 (azimuth ${wall2.normal_azimuth}°)`,
                showlegend: true,
            });

            // ========== FLOOR (triangular, bounded by rotated walls) ==========
            // Floor is the area between the two walls and extending inward
            const floorCorners = [
                [cornerX, cornerY],  // Corner
                [w1InnerEnd[0], w1InnerEnd[1]],  // End of wall 1
                [cornerX + wall1Length * wall1Dir[0] + wall2Length * wall2Dir[0],
                 cornerY + wall1Length * wall1Dir[1] + wall2Length * wall2Dir[1]],  // Far corner
                [w2InnerEnd[0], w2InnerEnd[1]],  // End of wall 2
            ];
            traces.push({
                type: 'mesh3d',
                x: floorCorners.map(c => c[0]),
                y: floorCorners.map(c => c[1]),
                z: [0, 0, 0, 0],
                i: [0, 0],
                j: [1, 2],
                k: [2, 3],
                color: 'rgba(200, 180, 160, 0.3)',
                name: 'Floor',
                showlegend: false,
                hoverinfo: 'name',
            });

            // Add windows with sun exposure coloring (positioned on rotated walls)
            config.windows.forEach((w, i) => {
                const axis = getWindowAxis(w);
                const isWall1 = axis === 'x';
                const receivesSun = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                const thickness = w.wall_thickness || 0;

                // Colors: bright yellow/orange if receiving sun, otherwise default
                let color, frameColor, outerColor;
                if (receivesSun) {
                    color = 'rgba(255, 200, 50, 0.8)';  // Bright yellow - sun hitting
                    outerColor = 'rgba(255, 220, 100, 0.6)';
                    frameColor = '#FF8C00';  // Dark orange frame
                } else {
                    color = isWall1 ? 'rgba(144, 238, 144, 0.5)' : 'rgba(135, 206, 235, 0.5)';
                    outerColor = isWall1 ? 'rgba(144, 238, 144, 0.3)' : 'rgba(135, 206, 235, 0.3)';
                    frameColor = isWall1 ? '#228B22' : '#4169E1';
                }

                // Window position along wall (from config x_position or y_position)
                const wallPos = getWindowCenterAlongWall(w);
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallNormal = isWall1 ? wall1Normal : wall2Normal;

                // Window center on wall (in world coordinates)
                const windowCenterX = cornerX + wallPos * wallDir[0];
                const windowCenterY = cornerY + wallPos * wallDir[1];

                // Window corners (perpendicular to wall = along wallDir, vertical = Z)
                const halfW = w.width / 2;
                const halfH = w.height / 2;
                const wz = w.center[2];

                let innerCorners = [
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz - halfH],
                    [windowCenterX + halfW * wallDir[0], windowCenterY + halfW * wallDir[1], wz + halfH],
                    [windowCenterX - halfW * wallDir[0], windowCenterY - halfW * wallDir[1], wz + halfH],
                ];

                // Outer corners (offset by wall thickness in outward normal direction)
                let outerCorners = innerCorners.map(c => [
                    c[0] - thickness * wallNormal[0],
                    c[1] - thickness * wallNormal[1],
                    c[2]
                ]);

                // Inner window mesh
                traces.push({
                    type: 'mesh3d',
                    x: innerCorners.map(c => c[0]),
                    y: innerCorners.map(c => c[1]),
                    z: innerCorners.map(c => c[2]),
                    i: [0, 0],
                    j: [1, 2],
                    k: [2, 3],
                    color: color,
                    name: w.id + ' (inner)',
                    showlegend: false,
                    hoverinfo: 'name',
                });

                // Inner window frame
                const innerFrameX = [...innerCorners.map(c => c[0]), innerCorners[0][0]];
                const innerFrameY = [...innerCorners.map(c => c[1]), innerCorners[0][1]];
                const innerFrameZ = [...innerCorners.map(c => c[2]), innerCorners[0][2]];
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: innerFrameX,
                    y: innerFrameY,
                    z: innerFrameZ,
                    line: { color: frameColor, width: 3 },
                    name: w.id,
                    showlegend: i === 0,
                });

                // Outer window (only if wall has thickness)
                if (thickness > 0) {
                    // Outer window mesh
                    traces.push({
                        type: 'mesh3d',
                        x: outerCorners.map(c => c[0]),
                        y: outerCorners.map(c => c[1]),
                        z: outerCorners.map(c => c[2]),
                        i: [0, 0],
                        j: [1, 2],
                        k: [2, 3],
                        color: outerColor,
                        name: w.id + ' (outer)',
                        showlegend: false,
                        hoverinfo: 'name',
                    });

                    // Outer window frame
                    const outerFrameX = [...outerCorners.map(c => c[0]), outerCorners[0][0]];
                    const outerFrameY = [...outerCorners.map(c => c[1]), outerCorners[0][1]];
                    const outerFrameZ = [...outerCorners.map(c => c[2]), outerCorners[0][2]];
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: outerFrameX,
                        y: outerFrameY,
                        z: outerFrameZ,
                        line: { color: frameColor, width: 2, dash: 'dot' },
                        name: w.id + ' outer frame',
                        showlegend: false,
                    });

                    // Tunnel edges (connect inner to outer corners)
                    for (let ci = 0; ci < 4; ci++) {
                        traces.push({
                            type: 'scatter3d',
                            mode: 'lines',
                            x: [innerCorners[ci][0], outerCorners[ci][0]],
                            y: [innerCorners[ci][1], outerCorners[ci][1]],
                            z: [innerCorners[ci][2], outerCorners[ci][2]],
                            line: { color: frameColor, width: 1 },
                            showlegend: false,
                            hoverinfo: 'skip',
                        });
                    }
                }
            });

            // Add plant cylinder
            // Plant is positioned at the room offset center (plantVizX, plantVizY)
            // This was calculated earlier: corner + plant.center = plantViz position
            const plantX = plantVizX;
            const plantY = plantVizY;
            const nPts = 20;
            const theta = Array.from({length: nPts}, (_, i) => 2 * Math.PI * i / nPts);

            // Bottom circle
            const xBottom = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yBottom = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zBottom = theta.map(() => plant.z_min);

            // Top circle
            const xTop = theta.map(t => plantX + plant.radius * Math.cos(t));
            const yTop = theta.map(t => plantY + plant.radius * Math.sin(t));
            const zTop = theta.map(() => plant.z_max);

            // Combine for mesh
            const allX = [...xBottom, ...xTop];
            const allY = [...yBottom, ...yTop];
            const allZ = [...zBottom, ...zTop];

            const iIdx = [], jIdx = [], kIdx = [];
            for (let idx = 0; idx < nPts; idx++) {
                const next = (idx + 1) % nPts;
                iIdx.push(idx, next);
                jIdx.push(next, next + nPts);
                kIdx.push(idx + nPts, idx + nPts);
            }

            traces.push({
                type: 'mesh3d',
                x: allX,
                y: allY,
                z: allZ,
                i: iIdx,
                j: jIdx,
                k: kIdx,
                color: 'rgba(34, 139, 34, 0.8)',
                name: 'Plant',
                showlegend: true,
            });

            // Helper function to find ray-window intersection (with rotated walls)
            function rayWindowIntersection(origin, direction, window) {
                // Get actual wall normal from config azimuth
                const azRad = window.wall_normal_azimuth * Math.PI / 180;
                const normal = [Math.sin(azRad), Math.cos(azRad), 0];

                const axis = getWindowAxis(window);
                const isWall1 = axis === 'x';
                const wallDir = isWall1 ? wall1Dir : wall2Dir;
                const wallPos = getWindowCenterAlongWall(window);

                // Window center on wall (in world coordinates)
                const windowCenter = [
                    cornerX + wallPos * wallDir[0],
                    cornerY + wallPos * wallDir[1],
                    window.center[2]
                ];

                const denom = direction[0]*normal[0] + direction[1]*normal[1] + direction[2]*normal[2];
                if (Math.abs(denom) < 1e-10) return null;

                const diff = [
                    windowCenter[0] - origin[0],
                    windowCenter[1] - origin[1],
                    windowCenter[2] - origin[2]
                ];
                const t = (diff[0]*normal[0] + diff[1]*normal[1] + diff[2]*normal[2]) / denom;
                if (t < 0) return null;

                return [
                    origin[0] + t * direction[0],
                    origin[1] + t * direction[1],
                    origin[2] + t * direction[2]
                ];
            }

            // Draw sun rays from far away through windows that receive sunlight
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];

                // Draw rays through each window that receives sun
                config.windows.forEach((w, wIdx) => {
                    const receivesSunRay = windowReceivesSun(w.wall_normal_azimuth, sunDir);
                    if (!receivesSunRay) return;

                    const axis = getWindowAxis(w);
                    const isWall1 = axis === 'x';
                    const wallDir = isWall1 ? wall1Dir : wall2Dir;
                    const wallPos = getWindowCenterAlongWall(w);

                    // Window center on rotated wall (in world coordinates)
                    const windowCenter = [
                        cornerX + wallPos * wallDir[0],
                        cornerY + wallPos * wallDir[1],
                        w.center[2]
                    ];

                    // Calculate sun position along the ray direction from window
                    const sunStart = [
                        windowCenter[0] + sunDist * sunDir[0],
                        windowCenter[1] + sunDist * sunDir[1],
                        windowCenter[2] + sunDist * sunDir[2]
                    ];

                    // Draw ray from far away (sun) through window into room
                    // Ray continues 10m past window into room (negative sun direction)
                    const roomEnd = [
                        windowCenter[0] - 10 * sunDir[0],
                        windowCenter[1] - 10 * sunDir[1],
                        windowCenter[2] - 10 * sunDir[2]
                    ];

                    // Only draw up to floor level (z >= 0)
                    if (roomEnd[2] < 0) {
                        const t = windowCenter[2] / (windowCenter[2] - roomEnd[2]);
                        roomEnd[0] = windowCenter[0] + t * (roomEnd[0] - windowCenter[0]);
                        roomEnd[1] = windowCenter[1] + t * (roomEnd[1] - windowCenter[1]);
                        roomEnd[2] = 0;
                    }

                    // Draw the incoming ray from sun to window (bright yellow)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [sunStart[0], windowCenter[0]],
                        y: [sunStart[1], windowCenter[1]],
                        z: [sunStart[2], windowCenter[2]],
                        line: { color: 'rgba(255, 215, 0, 0.6)', width: 3 },
                        name: wIdx === 0 ? 'Sun ray (incoming)' : '',
                        showlegend: wIdx === 0,
                    });

                    // Draw ray passing through window into room (brighter)
                    traces.push({
                        type: 'scatter3d',
                        mode: 'lines',
                        x: [windowCenter[0], roomEnd[0]],
                        y: [windowCenter[1], roomEnd[1]],
                        z: [windowCenter[2], roomEnd[2]],
                        line: { color: '#FFD700', width: 4 },
                        name: wIdx === 0 ? 'Sunlight in room' : '',
                        showlegend: wIdx === 0,
                    });

                    // Mark where light enters window
                    traces.push({
                        type: 'scatter3d',
                        mode: 'markers',
                        x: [windowCenter[0]],
                        y: [windowCenter[1]],
                        z: [windowCenter[2]],
                        marker: { size: 6, color: '#FF6600', symbol: 'circle' },
                        name: '',
                        showlegend: false,
                    });
                });

                // Also draw rays to plant hit points if plant is hit
                if (result.is_hit && result.hit_points) {
                    const hitWindow = config.windows.find(w => w.id === result.window_id);

                    result.hit_points.forEach((pt, i) => {
                        if (i < 3) { // Limit rays shown
                            // Convert hit point from ENU to visualization coordinates
                            const ptOffset = [pt[0] + cornerX, pt[1] + cornerY, pt[2]];

                            // Find window intersection for this ray
                            let windowPt = null;
                            if (hitWindow) {
                                windowPt = rayWindowIntersection(ptOffset, sunDir, hitWindow);
                            }

                            if (windowPt) {
                                // Draw ray from window to plant (showing light hitting plant)
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'lines',
                                    x: [windowPt[0], ptOffset[0]],
                                    y: [windowPt[1], ptOffset[1]],
                                    z: [windowPt[2], ptOffset[2]],
                                    line: { color: '#FF4500', width: 5 },
                                    name: i === 0 ? 'Ray hitting plant' : '',
                                    showlegend: i === 0,
                                });

                                // Mark hit point on plant
                                traces.push({
                                    type: 'scatter3d',
                                    mode: 'markers',
                                    x: [ptOffset[0]],
                                    y: [ptOffset[1]],
                                    z: [ptOffset[2]],
                                    marker: { size: 8, color: '#FF0000', symbol: 'diamond' },
                                    name: i === 0 ? 'Plant hit' : '',
                                    showlegend: i === 0,
                                });
                            }
                        }
                    });
                }
            }

            // Add sun indicator - far away so rays appear parallel (from "infinity")
            if (result.sun_direction) {
                const sunDir = result.sun_direction;
                // Sun very far away - rays will appear nearly parallel
                const sunDist = 80;
                const roomCenter = [ROOM_OFFSET_X + 8, ROOM_OFFSET_Y + 8, 5];
                const sunPos = [
                    roomCenter[0] + sunDist * sunDir[0],
                    roomCenter[1] + sunDist * sunDir[1],
                    Math.max(5, sunDist * sunDir[2]),
                ];

                // Sun marker (larger since it's further away)
                traces.push({
                    type: 'scatter3d',
                    mode: 'markers',
                    x: [sunPos[0]],
                    y: [sunPos[1]],
                    z: [sunPos[2]],
                    marker: { size: 25, color: '#FFD700', symbol: 'circle',
                              line: { color: '#FFA500', width: 3 } },
                    name: `Sun (El: ${result.elevation.toFixed(0)}°)`,
                    showlegend: true,
                });

                // Draw line from room center toward sun to show direction
                traces.push({
                    type: 'scatter3d',
                    mode: 'lines',
                    x: [roomCenter[0], sunPos[0]],
                    y: [roomCenter[1], sunPos[1]],
                    z: [roomCenter[2], sunPos[2]],
                    line: { color: 'rgba(255, 215, 0, 0.4)', width: 3, dash: 'dot' },
                    name: 'Sun direction',
                    showlegend: false,
                });
            }

            return traces;
        }

        function updatePlot(index) {
            const result = results[index];
            const traces = createPlotData(index);

            // Update info displays
            document.getElementById('currentTime').textContent = result.timestamp;
            document.getElementById('sunInfo').textContent =
                `Sun: Az ${result.azimuth.toFixed(0)}°, El ${result.elevation.toFixed(0)}°`;

            const statusEl = document.getElementById('statusDisplay');
            if (result.is_hit) {
                statusEl.textContent = '☀️ SUNLIGHT HITTING PLANT';
                statusEl.className = 'status hit';
                document.getElementById('windowInfo').textContent = `Through: ${result.window_id}`;
                const totalSamples = simSettings.sampleAngular * simSettings.sampleVertical;
                const hitCount = result.hit_points ? result.hit_points.length : 0;
                document.getElementById('hitPointsInfo').textContent = `Hits: ${hitCount}/${totalSamples} (${Math.round(100*hitCount/totalSamples)}%)`;
            } else {
                statusEl.textContent = 'No direct sunlight';
                statusEl.className = 'status miss';
                document.getElementById('windowInfo').textContent = '';
                document.getElementById('hitPointsInfo').textContent = '';
            }

            Plotly.react('plot3d', traces, {
                scene: {
                    xaxis: { title: 'X (meters)', range: [-30, 120] },
                    yaxis: { title: 'Y (meters)', range: [-30, 120] },
                    zaxis: { title: 'Z (meters)', range: [0, 80] },
                    aspectmode: 'cube',
                    camera: {
                        eye: { x: 1.2, y: 1.2, z: 0.7 }
                    }
                },
                title: `Sun-Plant Simulation - ${result.timestamp}`,
                showlegend: true,
                legend: { x: 0.02, y: 0.98 },
            });
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved config from localStorage
            loadConfigFromStorage();

            // Populate form fields with current config
            populateConfigFields();

            // Calculate initial results with current config
            recalculateAllResults();

            const slider = document.getElementById('timeSlider');

            slider.addEventListener('input', function() {
                currentIndex = parseInt(this.value);
                updatePlot(currentIndex);
            });

            // Auto-apply on Enter key in inputs
            document.querySelectorAll('.config-field input').forEach(input => {
                input.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') applyConfig();
                });
            });

            // Initial plot
            updatePlot(0);
        });
    </script>
</body>
</html>